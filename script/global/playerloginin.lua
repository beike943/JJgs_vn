-- ¹¦ÄÜËµÃ÷
-- ´Ë½Å±¾ÎÄ¼ş»áÔÚÍæ¼ÒÃ¿´Î½øÈëÈÎÒâÒ»¸ö·şÎñÆ÷(ÄÜÊ¶±ğ´ËÎÄ¼şµÄ)ºó×Ô¶¯Ö´ĞĞ main º¯ÊıÀïÃæµÄ½Å±¾
-- ¼òµ¥µÄËµ£¬ÇĞ»»µØÍ¼¡¢µÇÂ½ÓÎÏ·¶¼»áÖ´ĞĞ´Ë½Å±¾ÎÄ¼şÖĞ main º¯ÊıµÄÄÚÈİ

-- ¹¦ÄÜÄ¿µÄ
-- Í¨³£ÊÇ×÷ÎªÍæ¼ÒĞÂÕÊºÅ½¨Á¢ºó½øÈëÓÎÏ·Ç°³õÊ¼»¯Ò»Ğ©¸öÈËĞÅÏ¢
-- ±ÈÈç×Ô¶¯¼ÓÔØ³õÊ¼ÈÎÎñµÈ


--Ìí¼ÓÍ·ÎÄ¼şÊ±ÇëÈ·±£È«¾Ö±äÁ¿Óëº¯Êı²»»á³åÍ»¡¡Ìí¼ÓÍ·ÎÄ¼şÊ±ÇëÈ·±£È«¾Ö±äÁ¿Óëº¯Êı²»»á³åÍ»
--Ìí¼ÓÍ·ÎÄ¼şÊ±ÇëÈ·±£È«¾Ö±äÁ¿Óëº¯Êı²»»á³åÍ»	Ìí¼ÓÍ·ÎÄ¼şÊ±ÇëÈ·±£È«¾Ö±äÁ¿Óëº¯Êı²»»á³åÍ»
--Ìí¼ÓÍ·ÎÄ¼şÊ±ÇëÈ·±£È«¾Ö±äÁ¿Óëº¯Êı²»»á³åÍ»	Ìí¼ÓÍ·ÎÄ¼şÊ±ÇëÈ·±£È«¾Ö±äÁ¿Óëº¯Êı²»»á³åÍ»
--Ìí¼ÓÍ·ÎÄ¼şÊ±ÇëÈ·±£È«¾Ö±äÁ¿Óëº¯Êı²»»á³åÍ»	Ìí¼ÓÍ·ÎÄ¼şÊ±ÇëÈ·±£È«¾Ö±äÁ¿Óëº¯Êı²»»á³åÍ»
--Ìí¼ÓÍ·ÎÄ¼şÊ±ÇëÈ·±£È«¾Ö±äÁ¿Óëº¯Êı²»»á³åÍ»	Ìí¼ÓÍ·ÎÄ¼şÊ±ÇëÈ·±£È«¾Ö±äÁ¿Óëº¯Êı²»»á³åÍ»
Include("\\script\\task\\WeekEnd\\weekend_switch.lua");
Include("\\script\\online\\qingrenyuanxiao\\qryx_head.lua")
Include("\\script\\online\\laborday06\\laborday_head.lua");
Include("\\script\\online\\dragonboat06\\dragonboat_head.lua");
Include("\\script\\online\\dragonboat06\\mission_head.lua");
Include("\\script\\online\\plant\\tree_head.lua");
Include("\\script\\global\\mate_head.lua");
Include("\\script\\missions\\bw\\bwhead.lua");
Include("\\script\\online\\afterworldcup06\\hand_in_hand_head.lua");
Include("\\script\\shinynight_head.lua");
Include("\\script\\online\\zgc_public_fun.lua")
Include("\\script\\missions\\northwest_mission\\mission\\mission_head.lua")
Include("\\script\\global\\battlefield_callback.lua")
Include("\\script\\online\\qixi07\\qixi07_head.lua")
Include("\\script\\task\\lingshi_task.lua")
Include("\\script\\global\\c2s_execute_func.lua")
Include("\\script\\online\\viet_event\\new_year_09\\new_year_head.lua");

Include("\\script\\lib\\writelog.lua")
Include("\\script\\online\\viet_event\\200907\\eventopen.lua");--Ô½ÄÏ09Äê7ÔÂ»î¶¯¿ª¹ØÍ·ÎÄ¼ş
Include("\\script\\online\\viet_event\\200907\\event_head.lua");
Include("\\script\\online\\jpz_event\\first_tong\\first_tong_head.lua")
Include("\\script\\online\\viet_event\\200909\\event_head.lua");--09Äê9ÔÂÖĞÇï»î¶¯Í·ÎÄ¼ş
Include("\\script\\task\\richangrenwu\\init_task.lua");--ÎäÁÖÊ¹ÕßÈÕ³£»î¶¯Í·ÎÄ¼ş
Include("\\script\\online_activites\\player_login_today.lua");
Include("\\script\\online_activites\\player_login_common.lua");
Include("\\script\\online_activites\\daily_reset.lua");
Include("\\script\\online_activites\\2010_12\\activity_05\\head.lua");
Include("\\script\\online_activites\\2010_12\\activity_06\\head.lua");

Include("\\script\\system_switch_config.lua") --gtask switch
Include("\\script\\task\\global_task\\gtask_head.lua") --new task
Include("\\script\\online\\liangshanboss\\lsb_head.lua")
Include("\\script\\online\\olympic\\oly_head.lua")
Include("\\script\\task\\global_task\\gtask_data.lua")
Include("\\script\\online\\qianhe_tower\\qht_head.lua")
Include("\\script\\online\\dazitie\\dzt_head.lua")
Include("\\settings\\static_script\\meridian\\item_julingwan.lua")
Include("\\script\\item\\item_yunling_box.lua")--Ç·±âºĞ
Include("\\script\\function\\zq_battles\\zq_head.lua")
Include("\\settings\\static_script\\exchg_server\\exchgsvr_player_login.lua")
Include("\\script\\online\\tong_feast\\tf_head.lua")
Include("\\script\\online\\spring2014\\sp_head.lua")
Include("\\script\\online_activites\\2014_04\\wuxingfulongshu.lua")
Include("\\script\\task_access_code_def.lua")
Include("\\settings\\static_script\\meridian\\meridian_payer_login.lua")
Include("\\script\\misc\\observer\\observer_head.lua")
Include("\\settings\\static_script\\global\\merit.lua")
Include("\\script\\missions\\siling_trial\\slt_head.lua")
Include("\\script\\online\\item_buchang\\ibc_head.lua")

Include("\\script\\lib\\define.lua")
Include("\\script\\task_access_code_def.lua")
Include("\\script\\system_switch_config.lua")
Include("\\script\\lib\\writelog.lua")
Include("\\script\\online\\zgc_public_fun.lua")

--Ìí¼ÓÍ·ÎÄ¼şÊ±ÇëÈ·±£È«¾Ö±äÁ¿Óëº¯Êı²»»á³åÍ»	Ìí¼ÓÍ·ÎÄ¼şÊ±ÇëÈ·±£È«¾Ö±äÁ¿Óëº¯Êı²»»á³åÍ»
g_nBWAwardDate = 2014051200;	--±ÈÎä´ó»á½×¶ÎĞÔ·¢½±µÄ½áÊøÈÕÆÚ
Include("\\script\\online\\viet_event\\nationality\\head.lua"); -- Server ID header
Include("\\script\\online\\viet_event\\ip_bonus\\ip_head.lua") -- IP bonus
Include("\\script\\online\\viet_event\\vng_task_control.lua"); -- VNG Task Control
Include("\\script\\online_activites\\task_values.lua"); -- KS Task Control
Include("\\script\\online\\chuyen_sinh\\translife_head.lua")  -- Chuyen sinh VN
Include("\\script\\online\\viet_event\\platinum_card\\platinum_head.lua") 
Include("\\script\\vng\\vanmay_daohuu\\vanmay_npc.lua") 
Include("\\script\\vng\\vng_playerlogin.lua")
Include("\\script\\biwudahui\\tournament\\tournament_head.lua")

g_szThisFile = "\\script\\global\\playerloginin.lua"

--·µ»ØĞÇÆÚ¼¸£¬0´ú±íĞÇÆÚÌì
function GetWeekDay()
	return tonumber(date("%w"))
end;
--·µ»Øµ±Ç°Ğ¡Ê±ºÍ·ÖÖÓ
function GetLocalTime()
	nHour = date("%H");
	nMin = date("%M");
	return tonumber(nHour), tonumber(nMin)
end;

--19 - 23µã59·Ö
function CheckTime(day)

	--»î¶¯¿ª¹Ø
	if WEEKEND_SWITCH == 0 then
		return 0
	end;

	if day ~= GetWeekDay() then
		return 0
	end;

	local nBegin;
	local nEnd;
	if day == 0 then	--ÖÜÈÕÊÇÏÂÎç2£º00 - ÍíÉÏ10£º00
		nBegin = 14 * 60;
		nEnd = 22 * 60;
	else
		nBegin = 19 * 60;	--ÆäËûÈÕ×ÓÊÇÍíÉÏ7£º00µ½ÍíÉÏ12£º00
		nEnd = 24 * 60;
	end;

	local nHour, nMin = GetLocalTime();
	local nValue = nHour * 60 + nMin;
	if nValue >= nBegin and nValue <= nEnd then
		return 1
	else
		return 0
	end;
end;

function ItemLockAlert()
	local isfirst, haveitemunlock, bForceUnlock = GetItemLockStatus()
	if isfirst > 0 then
		Say("HÖ thèng khãa vËt phÈm gióp b¶o qu¶n tµi kho¶n \n Trong hµnh trang thªm nót khãa vËt phÈm, chØ cÇn thiÕt lËp mËt m· ban ®Çu lµ cã thÓ khãa vËt phÈm. §Ó biÕt thªm chi tiÕt nhÊn F1.", 0)
	end

	if haveitemunlock > 0 then
		Msg2Player("B¹n hiÖn cã vËt phÈm ®ang më khãa")
	end

	if bForceUnlock > 0 then
		Msg2Player("Trang bŞ khãa ®ang ë tr¹ng th¸i chØ ®Şnh më")
	end
end

function main(ExchangeComing)
	local nPlayerRoute = GetPlayerRoute();
	--NOTE: it MUST be the 1st one calling for resetting things by SunZhuoshi
	--< Added by SunZhuoshi
	DR_OnPlayerLogin();
	PLT_OnPlayerLogin();
	--PLC_OnPlayerLogin();
	-->
--	SB_OnPlayerLogin();
	FG_OnPlayerLogin();
	-->

	LearnSkill(11)	--ÑîÃÅ¼¼ÄÜ11
	LearnSkill(12)	--ÑîÃÅ¼¼ÄÜ12
	local nDate = tonumber(date("%Y%m%d"))
	-- ²Ø½£É½×¯£¬¶ÏÏßºóÖØĞÂÁ¬½Ó»Ø³Ç´¦Àí
	RemoveTrigger(GetTrigger(1101))
	RemoveTrigger(GetTrigger(1102))
	RemoveTrigger(GetTrigger(1103))
	RemoveTrigger(GetTrigger(1104))
	if GetTrigger(2517) ~= 0 then
		RemoveTrigger(GetTrigger(2517));
	end;
	if GetTrigger(2518) ~= 0 then
		RemoveTrigger(GetTrigger(2518));
	end;
	if GetTrigger(2519) ~= 0 then
		RemoveTrigger(GetTrigger(2519));
	end;
	local nMapID, nX, nY = GetWorldPos()
	if ((nMapID >= 1011) and (nMapID <= 1059)) or ((nMapID >= 2011) and (nMapID <= 2059)) or ((nMapID >= 3011) and (nMapID <= 3059))or ((nMapID >= 4011) and (nMapID <= 4059))or ((nMapID >= 5011) and (nMapID <= 5059)) then  --²Ø½£µØÍ¼Çø¼ä
		print("#Tµng KiÕm s¬n trang: Ng­êi ch¬i ["..GetName().."] xuÊt hiÖn sù cè kh¸c th­êng, ®øt kÕt nèi server, bŞ chuyÓn vÒ thµnh.")
		NewWorld(350,1397,2852)
		SetFightState(0)
	end

	-- É¾³ıÓ¢ĞÛÁîµÄµôÂä
	if (GetTrigger(100)~=0 and GetTask(1152) == 0) then
		SetTask(1152,1)
		RemoveTrigger(GetTrigger(100))
	end
	RemoveTrigger(GetTrigger(555))
	if GetTrigger(2509) ~= 0 then
		RemoveTrigger(GetTrigger(2509))
	end
	if GetTrigger(2516) ~= 0 then
		RemoveTrigger(GetTrigger(2516))
	end

	--¹«²âÊ±"½±È¯"µôÂä´¥·¢ÉèÖÃ
	RemoveTrigger(GetTrigger(260));	--2008Äê7ÔÂ31ÈÕÈ¥µô½±È¯µôÂä
	--================================================================
	--05ÄêÊ¥µ®»î¶¯
	if (nDate >= 20051223 and nDate <= 20051228) then
		if GetTrigger(3000) == 0 then
			CreateTrigger(0,1200,3000);
		end
			Msg2Player("Ho¹t ®éng lÔ gi¸ng sinh ®· b¾t ®Çu, h·y ®Õn TruyÒn gi¸o sÜ ë c¸c thµnh thŞ chİnh tra xem th«ng tin cô thÓ!")
	else
		if GetTrigger(3000) ~= 0 then
			RemoveTrigger(GetTrigger(3000));
		end;
	end
	--================================================================
	--06ÄêÔªµ©»î¶¯
	--ÒòÎª´º½Ú»î¶¯Ò²ÓĞÉ¾³ı¸ú°àµÄ²Ù×÷£¬ËùÒÔÏÂÃæµÄKillFollowerÔÚ´º½Ú»î¶¯ÆÚ¼äÒª×¢ÊÍµô
	--KillFollower()	--È·±£ÉÏÏß/¿ç·şµÄÊ±ºòÃ»ÓĞ¸ú°à
	RemoveTitle(3,3)	--È·±£ÉÏÏß/¿ç·şµÄÊ±ºòÃ»ÓĞ¡°ïÚÆìÔÚ´Ë£¡¡±µÄ³ÆºÅ
	if (nDate >= 20051231 and nDate <= 20060105) then
		local mapID = GetWorldPos()
		if mapID == 108 or mapID == 201 or mapID == 304 then
			SetDeathPunish(0)	--ÔÚ»î¶¯ÆÚ¼äÈ·±£ÉÏÏß/¿ç·şµÄÊ±ºò£¬½øÈë¶áÆìµØÍ¼Ã»ÓĞËÀÍö³Í·£¡£
		end
		local bCreateFailed = 0	--ÓÃÀ´¼ÇÂ¼´¥·¢Æ÷ÊÇ·ñ´´½¨³É¹¦
		if CreateTrigger(2,1700,3200) == 0 then	--½øÈëÈªÖİ¶áÆì±ÈÈüµØÍ¼´¥·¢Æ÷
			bCreateFailed = 1
		end
		if CreateTrigger(2,1701,3201) == 0 then	--Àë¿ªÈªÖİ¶áÆì±ÈÈüµØÍ¼´¥·¢Æ÷
			bCreateFailed = 1
		end
		if CreateTrigger(2,1702,3202) == 0 then	--½øÈëãê¾©¶áÆì±ÈÈüµØÍ¼´¥·¢Æ÷
			bCreateFailed = 1
		end
		if CreateTrigger(2,1703,3203) == 0 then	--Àë¿ªãê¾©¶áÆì±ÈÈüµØÍ¼´¥·¢Æ÷
			bCreateFailed = 1
		end
		if CreateTrigger(2,1704,3204) == 0 then	--½øÈë³É¶¼¶áÆì±ÈÈüµØÍ¼´¥·¢Æ÷
			bCreateFailed = 1
		end
		if CreateTrigger(2,1705,3205) == 0 then	--Àë¿ª³É¶¼¶áÆì±ÈÈüµØÍ¼´¥·¢Æ÷
			bCreateFailed = 1
		end

		if bCreateFailed == 1 then
			Msg2Player("B¹n kh«ng thÓ tham dù ho¹t ®éng TÕt Nguyªn §¸n trong lÇn ®¨ng nhËp nµy! H·y thö ®¨ng nhËp l¹i!")
		else
			Msg2Player("Ho¹t ®éng TÕt Nguyªn §¸n ®· b¾t ®Çu! Thêi gian ho¹t ®éng b¾t ®Çu tõ 31/12/2005 ®Õn 5/1/2006 kÕt thóc.")
			--TaskTip("Çëµ½ãê¾©¸®ÄÏ¡¢³É¶¼¸®ÄÏ¡¢ÈªÖİ¸®±±µÄ¶áÆì½ÌÍ·´¦ÁË½â¶áÆìÈüÏ¸Ôò¡£")
		end
	else
		for i = 3200,3205 do
			if GetTrigger(i) ~= 0 then
				RemoveTrigger(GetTrigger(i))
			end
		end;
	end
	--================================================================
	--06Äê´º½Ú»î¶¯
	if GetWorldPos() == 961 or GetWorldPos() == 962 or GetWorldPos() == 963 or GetWorldPos() == 964 or GetWorldPos() == 965 then
		SetDeathPunish(0)	--ÉÏÏßµ½Ñ©ÕÌµØÍ¼Ê±£¬ÎŞËÀÍö³Í·£
		for SkillID=843,851 do
			LearnSkill(SkillID)	--ÉÏÏßµ½Ñ©ÕÌµØÍ¼Ê±Ñ§»á´òÑ©ÕÌ¼¼ÄÜ
		end
		SetDeathScript("\\script\\online\\´º½Ú»î¶¯\\playerdeath.lua")
		UseScrollEnable(0)
	end

	if (nDate >= 20060120 and nDate <=20060205) then
		if CreateTrigger(0,1201,3100) == 0 then
			Msg2Player("B¹n ®¸nh qu¸i kh«ng r¬i ra vËt liÖu lµm b¸nh trong lÇn ®¨ng nhËp nµy. H·y thö ®¨ng nhËp l¹i!")
		end

		local id,idx = 0,0
		bCreateFailed = 0
		for i=1,5 do
			Tid = 1710 + i
			Tidx = 3100 + i
			if CreateTrigger(2,Tid,Tidx) == 0 then	--´´½¨Àë¿ªµØÍ¼´¥·¢Æ÷
				bCreateFailed = 1
			end
		end
		if bCreateFailed == 1 then
			Msg2Player("B¹n kh«ng thÓ tham gia nĞm tuyÕt b×nh th­êng trong lÇn ®¨ng nhËp nµy. H·y thö ®¨ng nhËp l¹i!")
			WriteLog("[Ho¹t ®éng mïa xu©n -KÕt nèi thÊt b¹i]:"..GetName().."§¨ng nhËp/mÊt kÕt nèi server rêi khái bé kÕt nèi map (3101-3105).")
		end
	else
		for i=3100,3105 do
			if GetTrigger(i) ~= 0 then
				RemoveTrigger(GetTrigger(i))
			end
		end
		local MapID = GetWorldPos()
		local Map_Pos = {
					{961,300,1820,3573},
					{962,200,1409,3048},
					{963,100,1365,2932},
					{964,350,1575,2970},
					{965,150,1781,3154}
					}
		for i=1,5 do
			if MapID == Map_Pos[i][1] then	--Èç¹û²»ÔÚ»î¶¯ÆÚ¼äÉÏÏßµ½Ñ©ÕÌµØÍ¼£¬Ôò´«ËÍ³öÈ¥¡£
				NewWorld(Map_Pos[i][2],Map_Pos[i][3],Map_Pos[i][4])
				if GetWorldPos() == Map_Pos[i][2] then
					SetDeathPunish(1)
					SetFightState(0)
					UseScrollEnable(1)
					SetTempRevPos(0,0,0)
					for SkillID=843,851 do
						if HaveLearnedSkill(SkillID) == 1 then
							RemoveSkill(SkillID)	--Íü¼Ç´òÑ©ÕÌ¼¼ÄÜ
						end;
					end
					SetDeathScript("")
					break
				end
			end
		end
	end

	--================================================================
	--06ÄêÇéÈË½Ú£¦ÔªÏü½Ú»î¶¯(Ô½ÄÏ°æ)
	if Is_QRYX_Activity() == 1 and GetSex() == 2 then
		CreateTrigger(0,1202,3110);					-- ´ò¹ÖµôÂäÇÉ¿ËÁ¦µÄ´¥·¢Æ÷
	elseif GetTrigger(3110) ~= 0 then
		RemoveTrigger(GetTrigger(3110))
	end
	--================================================================

	--08ÄêÇåÃ÷½Ú»î¶¯
	if nDate <= 20080412 then
		Msg2Player("Ho¹t ®éng tiÕt Thanh Minh ®· b¾t ®Çu, c¸c hiÖp kh¸ch h·y ®Õn DÉn Lé nh©n gÇn D· TÈu ®Ó biÕt th«ng tin chi tiÕt!");
	else	--·ÇÇåÃ÷½Ú»î¶¯ÆÚ¼äÉÏÏßµ½°İ¼ÀµØÍ¼Ê±£¬×Ô¶¯´«ËÍÍæ¼Ò³öÈ¥
		local Map_Pos_QM = {
					{818,100,1458,2807},
					{819,200,1170,2828},
					{820,300,1640,3526},
					}
		local MapID_QM = GetWorldPos();
		for i=1,getn(Map_Pos_QM) do
			if MapID_QM == Map_Pos_QM[i][1] then
				NewWorld(Map_Pos_QM[i][2],Map_Pos_QM[i][3],Map_Pos_QM[i][4]);
				break;
			end;
		end;
	end;
	--================================================================
	--06ÄêÎåÒ»½Ú»î¶¯
	----- bossºÍÉÌ»áÈÎÎñ µÇÂ½¹«¸æ----
	local nDate = tonumber(date("%Y%m%d"))
	if nDate >= 20060428 and nDate <= 20060430 then
		Msg2Player("21:30 tèi nay, boss M· TÆc ®Çu môc xuÊt hiÖn gÇn t©y BiÖn Kinh c­íp mÊt 1 con TuÊn M·, ®· ®Õn lóc c¸c hiÖp kh¸ch trõ h¹i cho d©n!")
		Msg2Player("PhÇn th­ëng NhiÖm vô Th­¬ng héi h«m nay rÊt phong phó! NhiÖm vô thø 10 vßng 2 vµ nhiÖm vô thø 10 vßng 3 ®Òu cã phÇn th­ëng lín chê ®îi b¹n!")
	end
	--================================================================
	--06Äê¶ËÎç½Ú»î¶¯
	if GetTask(1715) == 2 then
		WriteLog("Do tho¸t game ®ét ngét, dÉn ®Õn ng­êi ch¬i"..GetName().."Thay ®æi nhiÖm vô sè 1715 ch­a reset, v× thÕ khi ®¨ng nhËp cÇn tiÕn hµnh kh«i phôc tr¹ng th¸i cho ng­êi ch¬i.")
		Restore_Player_State();
	end;
	local nGenre,nDetail,nParticular = GetPlayerEquipInfo(10);
	local bOnBoat = 0;
	if nGenre == 0 and nDetail ==105 then
		for i=25,31 do
			if nParticular == i then
				bOnBoat = 1;
				break;
			end;
		end;
	end;
	if bOnBoat == 1 then
		UnEquipAtPosition(10);
	end;

	for i=854,859 do
		if HaveLearnedSkill(i) == 1 then
			RemoveSkill(i);
		end;
	end;
	if Get_DragonBoatDay_State() == 3 then
		bCreateFailed = 0;
		for i=0,5 do
			Tid = 1107 + i
			Tidx = 3113 + i
			if GetTrigger(Tidx) == 0 then
				if CreateTrigger(2,Tid,Tidx) == 0 then	--´´½¨½øÈëÀë¿ªÖÖÊ÷µØÍ¼´¥·¢Æ÷
					bCreateFailed = 1	--Ä³Ò»¸ö´¥·¢Æ÷´´½¨Ê§°ÜÁË
				end
			end;
		end;
		if bCreateFailed == 1 then
			Msg2Player("LÇn ®¨ng nhËp nµy khiÕn b¹n kh«ng thÓ tiÕn hµnh trång c©y b×nh th­êng! Vui lßng ®¨ng nhËp l¹i!")
			WriteLog("[Ho¹t ®éng Th¸i H­ Qu¶ Thô (KÕt nèi thÊt b¹i)]:"..GetName().."§¨ng nhËp/mÊt kÕt nèi server rêi khái bé kÕt nèi map (3113-3118).")
		end
	else
		for i = 3113,3118 do
			if GetTrigger(i) ~= 0 then
				RemoveTrigger(GetTrigger(i))
			end
		end;
	end;
	SetDeathScript("");
	SetTask(TASK_TREEINDEX,0);	--
	SetTask(TASK_TREEGROW,0);	--
	SetTask(TASK_PLANTTIME,0);
	--================================================================
	--Ğ¯ÊÖÊÀ½ç±­»î¶¯
	if GetTrigger(3119) ~= 0 then
		RemoveTrigger(GetTrigger(3119));
	end;
--	if GetTask(TASK_GOTPET_TIME) ~= 0 and GetTime() - GetTask(TASK_GOTPET_TIME) > 60*60*24 then
--		KillFollower();
--		SetTask(TASK_GOTPET_TIME,0);
--	end;
	--================================================================
	--¶àÈËÀŞÌ¨
	for i=1,getn(MultiMapTab) do
		if GetWorldPos() == MultiMapTab[i][1] then
			NewWorld(300,1832,3582)
		end
	end

	for i=1,getn(SingleTeamMapTab) do
		if GetWorldPos() == SingleTeamMapTab[i][1] then
			NewWorld(300,1832,3582)
		end
	end

	for i=1,getn(TeamMapTab) do
		if GetWorldPos() == TeamMapTab[i][1] then
			NewWorld(300,1832,3582)
		end
	end

	if GetTask(1151) == 1 then
		SetPlayerState(3);
		SetTask(1151,0);
	end
	--================================================================
	--ÖÜÄ©»î¶¯
	if WEEKEND_SWITCH == 1 then
		if GetTrigger(2000) == 0 then
			CreateTrigger(0, 1000, 2000);
		end;
	else
		if GetTrigger(2000) ~= 0 then
			RemoveTrigger(GetTrigger(2000));
		end;
	end;
	--================================================================
	--´óÀíÈÎÎñÃæ°å³ö´íĞŞÕı
	if GetTask(1314) >= 2 and (GetTask(1312) == 5 or GetTask(1313) == 4) then
		SetTask(1312,6);
		SetTask(1313,5);
	end
	--================================================================
	--Î÷±±ÈÎÎñÌáÊ¾
	if GetLevel() >= 70 and GetTask(2030) == 0 then
		Msg2Player("GÇn ®©y KhÊu chuÈn BiÖn Kinh nhËn ®­îc tin NhÊt PhÈm §­êng ®· hµnh ®éng t¹i biªn giíi T©y B¾c ®¹i Tèng, b»ng h÷u còng cã danh tiÕng trªn giang hå. Xin ra tay gióp ®ì.");
	end

	--ÔùËÍÎ÷ÓòÌ½ÃØÃÅÆ±ÌáÊ¾
	if GetTask(2031) >= 68 then
		give_xibei_ticket()
		if random(1,100) <= 33 then
			Msg2Player("§¹i Tèng v× muèn tiÖn cho c¸c ®¹i hiÖp trªn ®­êng v­ît ¶i thÇn bİ ®· ph¸i 1 MËt sø ë Phông T­êng phñ gióp ®­a c¸c ®¹i hiÖp ®Õn n¬i thÇn bİ, h·y ®Õn Phông T­êng (219, 196) ®Ó t×m hiÓu.")
		end
	end

	if GetTask(101) ~= 874 then
		remove_oldquest()	-- É¾³ıÔ­ÊÀ½çÈÎÎñ
	end

	if (IsInGatherMap() == 1) then
		SetInGatherMap(1)
	else
		SetInGatherMap(0)
	end

	if GetTask(1) == 0 then
	    SetTask(1, 100);
	    TaskTip("H­íng dÉn nhiÖm vô t©n thñ: B¸i kiÕn D· TÈu");
	end;

	if GetTask(111) > 0 and GetTask(111) < 100 then
	    SetTask(111, 0);
	end;

	if GetTask(121) > 0 and GetTask(121) < 100 then
	    SetTask(121, 0);
	    SetTask(122, 0);
	end;
	--================================================================
	-- »Ô»ÍÖ®Ò¹ÌáÊ¾
	ShowShinyNightMsg()
	--================================================================
	--ÀÎ·¿Ïà¹Ø
	if GetWorldPos() == 701 then
		SetCanRestorePK(1);	--4±¶ËÙ¶ÈÏûPKÖµ
		UseScrollEnable(0);	--²»ÄÜÊ¹ÓÃ»Ø³Ç·û
		ForbidRead(1);	--²»ÄÜĞŞÊé
	end;

	-- ³ÇÊĞÀÎ·¿Ïà¹Ø
	if GetWorldPos() >= 730 and GetWorldPos() <= 734 then
		StallEnable(0)	-- ²»ÄÜ°ÚÌ¯
		ForbidRead(1)	--²»ÄÜĞŞÊé
		UseScrollEnable(0)	--½ûÖ¹Ê¹ÓÃ»Ø³Ç
		SetFightState(0)
		ContinueTimer(GetTrigger(261))
	end
	--================================================================
	--Õ½³¡Ïà¹Ø
	if GetTask(800) == 0 then	--ĞÂÕ½³¡±äÁ¿Çå³ı
		for i=701,799 do
			if i ~= 747 then
				SetTask(i,0);
			end;
		end;
		SetTask(800,1);
	end;
	CalcBattleRank()	--ÉèÖÃÕ½³¡¾üÏÎ
	UpdateBattleMaxRank()
	VerifyEquip()		-- ¼ì²â×°±¸´©ÉÏÈ¥ÊÇ·ñÓĞĞ§
	if GetTask(741) == 1 then
		KillFollower();
		SetTask(741,0)
	end;
	--================================================================
	--½á»éÏà¹Ø
	UnSedan()	-- ÏÂ»¨½Î
	OnDoll()	-- ¼¤»îÌæÉíÍŞÍŞ
	--================================================================
	Del_overdue_goods();	--É¾³ı¹ıÆÚÎïÆ·
	--´å³¤µÄµÇÂ½Ö´ĞĞº¯Êı
	Zgc_login_fun_main()
	--================================================================
	--ÍÃĞ¡Ñ¾´ğÌâ¿òÏûÊ§±êÖ¾Î»Çå¿Õ
	SetTask(615,0)
	SetTask(629,0)  --ÊÕ·Ñ°æÊÇ628 IB°æÊÇ629
	--================================================================
	--07ÆßÏ¦»î¶¯
	local nQixiDate = tonumber(date("%Y%m%d"))
	if nQixiDate >= 20070816 and nQixiDate <= 20070830 then
		Msg2Player("Ho¹t ®éng ThÊt tŞch ®· khai m¹c, b¸ch Hoa sø gi¶ kh¾p n¬i ë trung t©m BiÖn Kinh , Thµnh §«, TuyÒn Ch©u ®· chuÈn bŞ v« sè lÔ vËt cho t×nh nh©n trong dŞp lÔ l·ng m¹n nµy, mau mau ®Õn xem!")
	end

	flower_time();
	--================================================================
	--ÒÆ³ıÒÑ¾­·ÏÖ¹µÄ¼¼ÄÜ: "»ìãçÈ­·¨"
	if HaveLearnedSkill("Hçn §én quyÒn ph¸p") == 1 then
		RemoveSkill("Hçn §én quyÒn ph¸p")
	end
	--================================================================
	--========ÁéÊ¯ÈÎÎñ==============
	if GetTask(TASK_LINGSHI_ID) == 0 then
		--talk_I();
	elseif GetLevel() >= 80 and GetTask(689) == 0 then	--µÈ¼¶´óÓÚµÈÓÚ80¼¶£¬µÚÒ»´ÎµÇÂ½
		local tbBWSay = {
					"Ta muèn ®Õn chç b¸o danh/go_to_biwudahui",
					"§Ó ta suy nghÜ/nothing",
					}
		Say("<color=green>Minh Chñ Kim S¬n<color>: Nh»m t¹o nªn mét giang s¬n th¸i b×nh thŞnh trŞ, triÒu ®×nh kh«ng ngõng xem träng vò trang. §Ó biªn c­¬ng kh«ng bŞ x©m l­îc vµ ®Ó vang danh sa tr­êng, §¹i héi tû vâ Thiªn H¹ §Ö NhÊt chİnh thøc b¾t ®Çu.",getn(tbBWSay),tbBWSay);
		SetTask(689,1,TASK_ACCESS_CODE_BIWUDAHUI);
	elseif GetLevel() >= 70 and GetTask(544) == 0 then --µÈ¼¶´óÓÚµÈÓÚ70¼¶£¬µÚÒ»´ÎµÇÂ½
		Talk(1,"about_suohun","<color=red>Nh¾c nhë quan träng<color>: Vâ l©m truyÒn kú 2 thªm biÖn ph¸p an toµn míi, mäi ng­êi cÇn chó ı:\nThªm <color=red>Ên khãa hån<color>, khãa vËt phÈm hiÖn t¹i ph©n 2 lo¹i, <color=red>Khãa th­êng<color> vµ <color=red>Khãa hån vËt phÈm<color>.\n<color=red>Khãa th­êng<color> lµ chøc n¨ng khãa vËt phÈm ®· më, vËt phÈm khãa kh«ng thÓ giao dŞch, nĞm bá, b¸n tiÖm vµ lµm c¸c thao t¸c ®Æc biÖt.\n<color=red>Ên khãa hån<color> tøc lµ thªm chøc n¨ng an toµn. VËt phÈm khãa hån <color=red>cã thÓ giao dŞch<color>, nh­ng <color=red>kh«ng thÓ<color> nĞm bá, b¸n tiÖm vµ lµm c¸c thao t¸c ®Æc biÖt.");
	elseif GetTask(549) == 0 then
		Say("    Vâ l©m truyÒn kú 2 chİnh thøc c«ng bè chøc n¨ng <color=yellow>Tù t×m ®­êng<color>. Tù t×m ®­êng, t×m NPC, t×m ng­êi ch¬i, dÔ sö dông.\n    NhÊn phİm '<color=red>G<color>' më b¶n ®å lín: T×m ®Şa ®iÓm hoÆc nhÊn c¸c b¶n ®å nhá ®Ó vµo, dÔ dµng ®Õn ®Şa ®iÓm bÊt k× trªn b¶n ®å; Còng cã thÓ t×m tªn NPC ®Ó tù t×m ®Õn NPC. NhÊn phİm '<color=red>H<color>', cã thÓ më toµn c¶nh b¶n ®å nhá ®Õn vŞ trİ bÊt kú trªn b¶n ®å.\n    Cã thÓ 'T×m ng­êi' qua danh s¸ch h¶o h÷u hoÆc cõu nh©n, danh s¸ch t¸n gÉu ®Ó t×m vŞ trİ ng­êi ch¬i.",0);
		SetTask(549,1);
--	elseif GetTask(443) == 0 then
--		Say("Thêi gian x¸c nhËn 5 giê ch¬i ®· hÕt, xin ®¨ng nhËp vµo <color=yellow>http://volam2.zing.vn ®Ó ®¨ng kı th«ng tin.",0);
--		SetTask(443,1);
	end;
	--========³ÇÊĞ³ÆºÅ==============
	local tTongCityTitle =
	{
		[100] = {5,6,7,8},
		[300] = {1,2,3,4},
		[350] = {9,10,11,12},
	}
	local szPlayerName_CityWarUse = GetName()
	for index, value in tTongCityTitle do
		local szSelfTong = GetTongName()
		local szTongName, _2, _3, nCityEndTime = GetCityWarInfo(index, "base")
		for i=1, 4 do
			if IsTitleExist(51, value[i]) > 0 then
				if szTongName == nil or szTongName ~= szSelfTong then
					RemoveTitle(51, value[1])
					RemoveTitle(51, value[2])
					RemoveTitle(51, value[3])
					RemoveTitle(51, value[4])
					break
				else
					if i == 1 or i == 2 then	-- ³ÇÖ÷or¿¤Ö÷
						local nCount, szBoss = GetCityWarInfo(index, "boss")
						if szBoss ~= szPlayerName_CityWarUse then
							RemoveTitle(51, value[1])
							RemoveTitle(51, value[2])
							RemoveTitle(51, value[3])
							RemoveTitle(51, value[4])
						end
					elseif i == 3 then			-- ¾üÊ¦
						local nCount, szManager = GetCityWarInfo(index, "manager")
						if szManager ~= szPlayerName_CityWarUse then
							RemoveTitle(51, value[1])
							RemoveTitle(51, value[2])
							RemoveTitle(51, value[3])
							RemoveTitle(51, value[4])
						end
					elseif i == 4 then			-- Ãû²¶
						local nCount, sF1, sF2, sF3, sF4 = GetCityWarInfo(index, "fighter")
						if not (sF1 == szPlayerName_CityWarUse or
							sF2 == szPlayerName_CityWarUse or
							sF3 == szPlayerName_CityWarUse or
							sF4 == szPlayerName_CityWarUse) then
								RemoveTitle(51, value[1])
								RemoveTitle(51, value[2])
								RemoveTitle(51, value[3])
								RemoveTitle(51, value[4])
						end
					end
				end
				break
			end
		end
	end
	--========µÚÒ»´Î½øÈëÓÎÏ·¸øÓè°İÊ¦Ìû=========
	if CustomDataRead("mp_p_give_baishitie") == nil then
		AddItem(2,1,587,1,1)
		CustomDataSave("mp_p_give_baishitie", "d", 0)
	end
	--=============´¢ÎïÏä¼ÓÒ³============================
	if GetTask(TASK_CHUWUXIANG_JIAYE) ~= 1 and GetTask(805) >= 2 and GetStoreBoxPageCount() <= 4 then
		SetStoreBoxPageCount(GetStoreBoxPageCount()+1);
		SetTask(TASK_CHUWUXIANG_JIAYE,1);
		Msg2Player("Toµn thÓ nh©n viªn Vâ L©m 2 chóc b¹n ch¬i vui vÎ, chóng t«i tÆng b¹n thªm 1 R­¬ng chøa ®å, chóc b¹n kÕt thªm nhiÒu b¹n míi.");
	end
	--===============08Èı°Ë½Ú================================
	if GetTask(2407) ~= 0 and GetTime() - GetTask(2407) > 60*60*24 then
		KillFollower();
		SetTask(2407,0);
	end;
	if GetTask(444) == 0 and nPlayerRoute == 21 then	--Èç¹ûÊÇ¹ÆÊ¦µÚÒ»´ÎÉÏÏß
		AddItem(2,0,1063,1);	--¸øËûÒ»¸öÉñÄ¾Íõ¶¦
		Msg2Player("B¹n nhËn ®­îc 1 ThÇn Méc V­¬ng §Ønh");
		TaskTip("B¹n nhËn ®­îc 1 ThÇn Méc V­¬ng §Ønh");
		SetTask(444,1);
	end;
	if nPlayerRoute == 21 then
		sync_guinsect_num_in_guding();	--Í¬²½¹ÆÊ¦¹Æ¶¦ÀïÃæµÄ¹ÆµÄÊıÁ¿¸ø¿Í»§¶Ë
	end;
	
	--¿ç·şÉÏÏß²Ù×÷
	exchgsvr_on_player_login()--Ôçµã×ö
	
	process_biwudahui();	--´¦Àí±ÈÎä´ó»áÏà¹ØÄÚÈİ
	process_shimenguanka();	--´¦ÀíÊ¦ÃÅ¹Ø¿¨Ïà¹ØÄÚÈİ
	process_ip_issue();		--ÓëÉÏ´ÎµÇÂ½IP²»Í¬Ê±¸øÌáÊ¾


	--===================================´´½¨½øÈëÀë¿ªÁúÈª´åµØÍ¼´¥·¢Æ÷(ÌìÏÂµÚÒ»°ï)======================================
	first_tong_pk_config();
--	AddItemForViet200906()
--	AddItemForViet200909()
	AddItemForViet200911()
    	AddItemForViet200912()
-- B¶o vÖ R­¬ng Tµi Nguyªn
	local nDate = tonumber(date("%w"))
	if nDate == 3 then
		if GetTrigger(3204) == 0 then
			if CreateTrigger(2,1704,3204) == 0 then	--½øÈë³É¶¼¶áÆì±ÈÈüµØÍ¼´¥·¢Æ÷
				WriteLog(GetName().." CreateTrigger 1704 failed")
			end
		end
		if GetTrigger(3205) == 0 then
			if CreateTrigger(2,1705,3205) == 0 then	--Àë¿ª³É¶¼¶áÆì±ÈÈüµØÍ¼´¥·¢Æ÷
				WriteLog(GetName().." CreateTrigger 1705 failed")
			end
		end
	else
		for i = 3204,3205 do
			if GetTrigger(i) ~= 0 then
				RemoveTrigger(GetTrigger(i))
			end
		end;
	end

     --È¡³öÈÕ³£»î¶¯µÄÀàĞÍ
     set_ruchangrenwu_type()
	
	if GetPlayerRoute() ~= 0 then
		local nDate = tonumber(date("%w%H"))
		if nDate >= 319 and nDate < 320 then
			local nMapID, nX, nY = GetWorldPos()
			if nMapID == 304 then
				local szTongName, nCessBuysell, nCessStore, nTime = GetCityWarInfo(300, "base")
				if IsTongMember() == 0 or GetTongName() ~= szTongName then
					LeaveTeam()
					local nFlag = random(1,2)
					SetPKFlag(1,nFlag)
					ForbidChangePK(1)
					SetTaskTemp(105,1)
				end
			end
		end
	end
	
-- reset VNG TaskID	
	ResetTask()
	removeLiangshan()
	
-- VNG clear event item
	DelEventItem()
		
-- VNG IP Bonus
	IpBonusReset()
	IpBonusStart()
	
-- Server ID
--	get_server_id()
	vng_set_nationality()
	if gf_GetTaskByte(TSK_SERVER_ID, TSK_SERVER_ID_CUR) == 49 then
		gf_SetTaskByte(TSK_SERVER_ID, TSK_SERVER_ID_CUR, 52)
		return
	elseif  gf_GetTaskByte(TSK_SERVER_ID, TSK_SERVER_ID_CUR) == 45 then
		gf_SetTaskByte(TSK_SERVER_ID, TSK_SERVER_ID_CUR, 53)
		return
	elseif  gf_GetTaskByte(TSK_SERVER_ID, TSK_SERVER_ID_CUR) == 54 then
		gf_SetTaskByte(TSK_SERVER_ID, TSK_SERVER_ID_CUR, 50)
		return
	elseif gf_GetTaskByte(TSK_SERVER_ID, TSK_SERVER_ID_CUR) == 30 then
		gf_SetTaskByte(TSK_SERVER_ID, TSK_SERVER_ID_CUR, 12)
		return
	elseif  gf_GetTaskByte(TSK_SERVER_ID, TSK_SERVER_ID_CUR) == 46 then
		gf_SetTaskByte(TSK_SERVER_ID, TSK_SERVER_ID_CUR, 16)
		return
	elseif  gf_GetTaskByte(TSK_SERVER_ID, TSK_SERVER_ID_CUR) == 51 then
		gf_SetTaskByte(TSK_SERVER_ID, TSK_SERVER_ID_CUR, 17)
		return
	end
	
--	if gf_GetTaskByte(TSK_SERVER_ID,1) ~= GetGlbValue(GLB_TSK_SERVER_ID) then
--		gf_SetTaskByte(TSK_SERVER_ID,1,GetGlbValue(GLB_TSK_SERVER_ID))
--	end
	
-- Add TiÕu Ng¹o Giang Hå Lôc nÕu ch­a cã
	if GetItemCount(2, 1, 30240) < 1 then
		AddItem(2, 1, 30240, 1)
		Msg2Player("B¹n nhËn ®­îc 1 quyÓn TiÕu Ng¹o Giang Hå Lôc!")
	end	
	
-- Th«ng b¸o sö dông ®Çu thµnh
	if GetTask(2154) > 0 then
		TaskTip("B¹n ®· kİch ho¹t sö dông §Çu Thµnh Tİn, §Çu Thµnh Th­, §Çu Thµnh BiÓu. §Ó hñy bá kİch ho¹t h·y ®Õn BiÖn Kinh t×m TriÖu Phæ.")
	end
	vng_merge_server()
	local nCheckLServer = GetGlbValue(GLB_TSK_SERVER_ID)
	if nCheckLServer < 150 or nCheckLServer > 158 then
		init_new_server()
		Init_Change_Server()
	end
	
	-- Set ID cho server Thµnh Long
	local nDateSpec = tonumber(date("%y%m%d"))
	if nDateSpec >= 111223 and nDateSpec <= 120123 then
		if gf_GetTaskByte(TSK_SERVER_ID, TSK_SERVER_ID_CUR) ~= 70 and GetGlbValue(GLB_TSK_SERVER_ID) == 70 then
			gf_SetTaskByte(TSK_SERVER_ID, TSK_SERVER_ID_CUR, 70)
		end
	end
	
	vng_playerlogin_init()
	
	local nDenBuDate = tonumber(date("%y%m%d"))
	if nDenBuDate >= 120814 and nDenBuDate <= 120814 then
		DenBu_BKL()
	end
	
--  Khu  vùc trång b¸t nh· lín
	local nMapID = GetWorldPos()
	if (nMapID  == 301 or  nMapID == 108) and GetFightState() == 0 then
		SetFightState(1)
	end
	-- ´¦Àí°×¾Ôµ÷Õû£¬×¢Òâ·ÅÔÚ×îºó£¡
	if ExchangeComing == 0 then
		OfflineLiveEx()
	end
	if gf_GetTaskByte(TSK_SERVER_ID, TSK_SERVER_ID_CUR) == 49 then
		gf_SetTaskByte(TSK_SERVER_ID, TSK_SERVER_ID_CUR, 52)
	elseif  gf_GetTaskByte(TSK_SERVER_ID, TSK_SERVER_ID_CUR) == 45 then
		gf_SetTaskByte(TSK_SERVER_ID, TSK_SERVER_ID_CUR, 53)
	elseif  gf_GetTaskByte(TSK_SERVER_ID, TSK_SERVER_ID_CUR) == 54 then
		gf_SetTaskByte(TSK_SERVER_ID, TSK_SERVER_ID_CUR, 50)
	elseif gf_GetTaskByte(TSK_SERVER_ID, TSK_SERVER_ID_CUR) == 31 then
		gf_SetTaskByte(TSK_SERVER_ID, TSK_SERVER_ID_CUR, 43)
	elseif gf_GetTaskByte(TSK_SERVER_ID, TSK_SERVER_ID_CUR) == 18 then
		gf_SetTaskByte(TSK_SERVER_ID, TSK_SERVER_ID_CUR, 16)
	elseif gf_GetTaskByte(TSK_SERVER_ID, TSK_SERVER_ID_CUR) == 37 then
		gf_SetTaskByte(TSK_SERVER_ID, TSK_SERVER_ID_CUR, 26)
	end
	--==========================================201110ÔÂº£ÉÏÁúÖÛÕ½==============================
	if GetTask(2929) == 2 then
		dragon_boat_201110()
	end
	--==============================================
	
	local nDate = tonumber( date( "%y%m%d" ) )
	local nCurDate = floor ( GetTask( TSK_NEWRES_CALC_DAILY ) / 10 ) 
	if nCurDate ~= nDate then
		SetTask ( TSK_NEWRES_CALC_DAILY, nDate * 10 )
	end
	
	local nWeek = tonumber ( date ("%w") ) -- tr¶ vÒ ngµy trong tuÇn
	-- ChØ reset task vµo thø 5 vµ thø 7
	if  nWeek == 4 or nWeek == 6 or nWeek == 0 then
		if mod(GetTask(TSK_NEWRES_CALC_DAILY), 10) == 0 then
			SetTask(TSK_TRANS_POINT_ALLOW,0)
			SetTask(TSK_NEWRES_CALC_DAILY,GetTask(TSK_NEWRES_CALC_DAILY) + 1)			
		end
	end
	-------------------------------------------------------------------------------------------------------------------------------------------
--	--Check ngµy hÕt h¹n B¹ch Kim LÖnh BKL
--	local nBKL_End = GetTime()
--	local nCountBKL = CheckCharged_BKL() 
--	local nCountBKLbyTSK = GetTask(TSK_BKLB_COUNT)
--	local nActivebyTSK = GetTask(TSK_BKLB_ACTIVE)
--	--Msg2Player("Gİa trŞ byte 1: "..nCountBKL)
--	--Msg2Player("Gi¸ trŞ n¹p by task: ".. nCountBKLbyTSK)
--	--Msg2Player("Gi¸ trŞ kich ho¹t by task: ".. nActivebyTSK)
--
--	if CheckAccountExt_BKL() <= 0 then
--	--Msg2Player("§· vµo 1")
--		if nCountBKLbyTSK > nCountBKL then
--			--Msg2Player("§· vµo 2")
--			nCountBKL = nCountBKLbyTSK
--			local nTempExt = GetExtPoint(EXT_POINT_BKLB)
--			PayExtPoint(EXT_POINT_BKLB, nTempExt)
--			--SetByte(nTempExt,1, nCountBKL)
--			gf_SetExtPointByte(EXT_POINT_BKLB, BYTE_BKLB_COUNT, nCountBKL)
--			--local tam1 = gf_GetExtPointByte(EXT_POINT_BKLB, BYTE_BKLB_COUNT)  -- xãa
--			--Msg2Player("Gi¸ trŞ byte 1 Ext sau: ".. tam1)			
--			--SetByte(nTempExt,2, nActivebyTSK)
--			gf_SetExtPointByte(EXT_POINT_BKLB, BYTE_BKLB_TYPE, nActivebyTSK)
--			--local tam2 = gf_GetExtPointByte(EXT_POINT_BKLB, BYTE_BKLB_TYPE) 			
--			--Msg2Player("Gi¸ trŞ byte 2 Ext sau: ".. tam2)			
--			--AddExtPoint(EXT_POINT_BKLB, nTempExt)
--			--Msg2Player("Gi¸ trŞ n¹p Ext sau: ".. nTempExt)			
--			
--		end
--	end
--	if GetTask(TSK_BKLB_ACTIVE) > 0 then -- or nCountBKL >= 1 	--nCountBKLbyTSK == nCountBKL and 
--	--Msg2Player("§· vµo 3")
--		if nCountBKL == nCountBKLbyTSK then
--		--Msg2Player("§· vµo 4")
--			if nBKL_End - GetTask(TSK_BKLB_START) > 5270400 then --and CheckAccountExt_BKL() <= 0  chØ cÇn check ~ tr­êng hîp ®· n¹p trong game
--			--Msg2Player("§· vµo 5")
--				SetTask(TSK_BKLB_ACTIVE,0)
--				--local nTempExt1 = GetExtPoint(EXT_POINT_BKLB)
--				--PayExtPoint(EXT_POINT_BKLB, nTempExt1)
--				gf_SetExtPointByte(EXT_POINT_BKLB, BYTE_BKLB_TYPE, 0)
--				--SetByte(nTempExt1,2, 0)
--				--AddExtPoint(EXT_POINT_BKLB, nTempExt1)		
--				--gf_SetExtPointByte(EXT_POINT_BKLB, BYTE_BKLB_COUNT, nCountBKL)
--				Msg2Player("B¹ch Kim LÖnh ®· hÕt hiÖu lùc. Vui lßng kİch ho¹t l¹i.")
--				Talk(1, "", "<color=green>Chñ Phßng M¸y<color>: B¹ch Kim LÖnh ®· hÕt hiÖu lùc. Vui lßng kİch ho¹t l¹i.")
--			end	
--		end
--	end
--	--------------- xãa trïng task HKLB
--	if nDate >= 120323 and nDate <=120329 then
--		if GetTask(TSK_BKLB_HAVETASK) == 0 and GetTask(TSK_BKLB_START) >= 1332370895 and GetTask(TSK_BKLB_START) <= 1332457260 then
--			SetTask(2720, GetTask(2282))
--			SetTask(TSK_BKLB_HAVETASK, 1)
--		end
--	end
	--====================¹Ø¿¨ÈÎÎñµÈĞÂÔö¼¼ÄÜ¶¼ÔÚÕâÀï´¦ÀíÉ¾³ı==============================
	--RemoveNewSkill()
	--=================²ÆÉñ±¦Ïä=====================================================
	treasure_box()
	--gtaskÖ§³ÖNPC¶Ô»°´¥·¢Æ÷ [·¢ÏÖ´¥·¢Æ÷ÓĞÒì³£]
	gtask_support()
	--¹Ø¿¨Ö¸ÒıÈÎÎñ£¨ĞÅ¼ş£©
	get_message_task()
	--¸øÓè°ËØÔ±¦µä
	--give_baguabaodian();
	VietResetDate() -- reset task mçi ngµy
	--ÌôÕ½ÁºÉ½boss»î¶¯
	LSB_Challenge_Trigger();
	--°ÂÔË»î¶¯
	oly_create_trigger();
	--Ç§Ñ°Ëş´¥·¢Æ÷´´½¨
	qht_create_trigger();
	--×·»Ø×ÖÌû´ó×÷Õ½
	dzt_tmz_trigger();
-- NhiÖm vô ®¸nh qu¸i chuyÓn sinh 6
	if GetTask(TSK_CS6_TULINH) == 4 then
		CreateTrigger(0,1279,2558)
	end
	if GetByte(GetTask(TRANSLIFE_TASK_ID), TRANSLIFE_BYTE_FLAG_LEVEL) == 1 then
		local nLevel_CS6 = GetByte(GetTask(TRANSLIFE_TASK_ID), TRANSLIFE_BYTE_SAVE_LEVEL)
		SetLevel(nLevel_CS6,0)
		gf_SetTaskByte(TRANSLIFE_TASK_ID, TRANSLIFE_BYTE_FLAG_LEVEL, 0)	
	end
	---------	
	--VËn may ®¹o h÷u
--	if nDate > 130423 and nDate <= 131230 then
		vanmay_daohuu()		--tİnh n¨ng ®ang ®ãng (set ®iÓm vÒ 100, khi më l¹i ph¶i më giíi h¹n ngµy th¸ng)
--	end	
--	if nDate <= 130423 then --®Òn bï ngµy 22/4/2013
--		vanmay_daohuu_denbu()
--	end	
	--ÉÏÏßÁìÈ¡Ç·±âºĞÌáÊ¾
	show_yunling_box_login_message()
	--ÕæÆøÕ½³¡
	ZQ_Leave_Game();
	--°ï»áÊ¢ÑçµÄBUFF
	tf_PlayerLoginAddBuff();
	--NpcËÀÍö´¥·¢Æ÷
	--\script\global\npcdeath_trigger.lua
	if GetTrigger(1297*2) <= 0 then
		CreateTrigger(0, 1297, 1297*2);
	end
	--´º½Ú»î¶¯
	sp_CreateTalkTrigger();
	--»î¶¯µÀ¾ßÌí¼Ó
	wxfls_AddItemPlayerlogin();
	
	onlogin_fix_meridian_attr_point_addon()--×Ô¶¯ĞŞ¸´¾­Âö´øÀ´µÄÇ±ÄÜµãÉÏÏŞÀ©Õ¹
	
	Observer:onEvent(SYSEVENT_PLAYER_LOGIN, ExchangeComing)
	--µÇÂ¼¼ì²éÎäÁÖ¹¦Ñ«°æ±¾ÊÇ·ñĞèÒª¸üĞÂ
	merit_PlayerLogin();
	--ËÄÁéÊÔÁ¶¸±±¾
	slt_LeaveGame();
	ibc_PlayerLogin(); --ºÚµÀ¾ß²¹³¥»î¶¯
	
	-------------------------------------------------------
end;
--*****************************É¾³ı¹ıÆÚÎïÆ·*************************
overdue_goods_list = {
	--×°±¸´óÀà-¸±Àà------------------------Ğ¡ÀàÁĞ±í---------------------ÓĞĞ§ÆÚ£¨Ìì£©--É¾³ıÎïÆ·ÌáÊ¾
	{0,		109,173,174,175,176,189,190,191,192,193,194,195,196,197,198,199,200,201,202,203,204,205,206,207,208,209,210,211,212,1,"Y phôc h«n lÔ b¹n thuª ®· hÕt h¹n!"},	--½á»éÒÂ·ş
	{0,		108,131,132,133,134,143,144,145,146,147,148,149,150,151,152,153,154,155,156,157,158,159,160,161,162,163,164,165,166,1,"Trang søc h«n lÔ b¹n thuª ®· hÕt h¹n!"},	--½á»éÍ·ÊÎ
	{0,		109,177,178,179,180,1,"Chñ h«n lÔ b¹n thuª ®· hÕt h¹n!"},
	{0,		105,32,1,"KiÖu hoa h«n lÔ b¹n thuª ®· hÕt h¹n!"},
	-- PhÇn nµy kh«ng Merg khi cã event míi
	--{0,		105,33,1,"Niªn thó cña b¹n ®· hÕt h¹n!"},
}
function Del_overdue_goods()
	local time_now = GetTime()
	local obj_index, item_index = GetFirstItem();
	local nDeletedCount = 0;
	while (obj_index ~= 0 and item_index ~= 0) do
		local genre = GetItemGenre(item_index)
		local detail = GetItemDetail(item_index)
		local particular = GetItemParticular(item_index)
		for i = 1, getn(overdue_goods_list) do
			local nSize = getn(overdue_goods_list[i]);
			if genre == overdue_goods_list[i][1] and detail == overdue_goods_list[i][2] then
				for j = 3,nSize-2 do
					if particular == overdue_goods_list[i][j] and time_now - GetItemCreateTime(item_index) >= (86400 * overdue_goods_list[i][nSize-1]) then
						DelItemByIndex(item_index,-1)
						Msg2Player(overdue_goods_list[i][nSize])
						nDeletedCount = nDeletedCount + 1;
					end
				end
			end
		end
		obj_index, item_index = GetNextItem(obj_index, item_index)
	end
	if nDeletedCount ~= 0 then
		Say("B¹n cã "..nDeletedCount.."vËt phÈm ®· hÕt h¹n, chi tiÕt xem hÖ thèng th«ng b¸o!",0);
	end;
end

function add_pouch_new_year_09_viet(tItem, szLog)
	local szItemName = tItem[1]
	local G, D, P = tItem[2], tItem[3], tItem[4]
	local nItemNum = tItem[5]
	local nRetCode = 0

	nRetCode = AddItem(G, D, P, nItemNum)
	if nRetCode == 1 then
		Msg2Player("B¹n nhËn ®­îc  "..nItemNum.." c¸i "..szItemName)
		WriteLogEx(szLog, "NhËn ®­îc", nItemNum, szItemName, format("(%d,%d,%d)", G, D, P), GetTongName() )
	else
		WriteLogEx(szLog, "NhËn ®­îc", nItemNum, szItemName, format("(%d,%d,%d)", G, D, P), GetTongName(), "Thu ®­îc thÊt b¹i, ".."AddItem return value = "..nRetCode)
	end
end

function remove_oldquest()
	SetTask(101, 874)
	if GetTrigger(51) ~= 0 then
		RemoveTrigger(GetTrigger(51))
	end
	if GetTrigger(52) ~= 0 then
		RemoveTrigger(GetTrigger(52))
	end
	if GetTrigger(53) ~= 0 then
		RemoveTrigger(GetTrigger(53))
	end
	if GetTrigger(61) ~= 0 then
		RemoveTrigger(GetTrigger(51))
	end
	if GetTrigger(71) ~= 0 then
		RemoveTrigger(GetTrigger(51))
	end
	if GetTrigger(72) ~= 0 then
		RemoveTrigger(GetTrigger(51))
	end
end

-- ÏÂ½Î
function UnSedan()
	local genre, detail, particular = GetPlayerEquipInfo(10)
	if (genre == 0 and detail == 105 and particular == 32) then
		DesaltPlayer(1, 7)
	end
end

function OnDoll()
	if (GetTask(TASKVAR_DOLLTIME) ~= 0) then
		if (GetMateOnlineStatus() == 1) then
			KillFollower()
			ActivateDoll(0)
		else
			local follower = GetFollower()
			if follower > 0 then
				SetCurrentNpcSFX(follower, SFX_DOLL, 1, 1)
			end;
			ActivateDoll(1)
		end
	end
end

function ShowShinyNightMsg()
	local system = GetGlbValue(GAMESVRGLB_SYSTEM)
	local multiple = GetGlbValue(GAMESVRGLB_MULTIPLE)
	if (system ~= 0) then
		Msg2Player(format("»Ô»ÍÖ®Ò¹»î¶¯½øĞĞÖĞ£¬½±Àø·­±¶µÄÏµÍ³ÊÇ%s£¬±¶ÂÊÊÇ%1.1f",
			map_sysnames[system],
			multiple / 100))
	end
end

--=================================´å³¤µÄµÇÂ½Ö´ĞĞº¯Êı=============================
function Zgc_login_fun_main()
	player_out_huashan()
	nw_mission_out()
	tomb_sweep_2008()
	ma_same_heart_deal()			--Í¬ĞÄÖµ×Ô¶¯´¦Àí
	task_talk_deal()				--ÈÎÎñÌáÊ¾´¦Àí
end

--*********************************»ªÉ½¾º¼¼******************************
function player_out_huashan()
	--¹¦ÄÜ£º½«ÔÚ»ªÉ½ÇøÏÂÏßºóÉÏÏßµÄÍæ¼ÒÇåÀí³ö»ªÉ½µØÍ¼¡£
	local map_id = GetWorldPos()
	if map_id == 969 then
		NewWorld(100,1420,2989)
	end
end


--Î÷±±¹Ø¿¨´«³ö´¦Àí
function nw_mission_out()
	local mapid = GetWorldPos()
	for i= 1, 6 do
		for j	= 1,2 do
			for k = 1,getn(Stage_info[i].map[j]) do
				if Stage_info[i].map[j][k] == mapid then
					Ms_on_log_in()
					break
				end
			end
		end
	end
end

function north_west_mission_out()
	local mission_diff = GetTask(Task_ID_stage_diff)
	if mission_diff == 2 then
		SetPKFlag(1,1)		--PK×´Ì¬
		ForbidChangePK(0)	--½ûÖ¹×ª»»PK×´Ì¬
	end
	UseScrollEnable(1)	--¿ÉÒÔÊ¹ÓÃ»Ø³Ç·û
	ForbitTrade(0)		--¿ÉÒÔ½»Ò×
	StallEnable(1)		--¿ÉÒÔ°ÚÌ¯
	SetDeathPunish(1)	--ÓĞËÀÍö³Í·£
	OpenFriendliness(1)	--Ôö¼ÓºÃ¸Ğ¶È
	RestoreAll()		--È«²¿»Ø¸´
end
--*******************************2008ÇåÃ÷½Ú»î¶¯**************************
function tomb_sweep_2008()
	--´¥·¢Æ÷É¾³ı
	local task_diff = GetTask(1854)
	local nDate = tonumber(date("%Y%m%d"));
	if nDate <= 20080412 then
		return
	end
	if task_diff ~= 1 and task_diff ~= 3 and task_diff ~= 8 and task_diff ~= 10 then
		return
	end
	for i = 900,903 do
		local trigger_ID = GetTrigger(i)
		if trigger_ID ~= 0  then
			RemoveTrigger(GetTrigger(trigger_ID))
		end
	end
end
--******************************Í¬ĞÄÖµË¥¼õ´¦Àí***************************
TaskID_attenuation_date_seq = 1219
TaskID_same_heart_value = 2015
Same_heart_value_max_TaskID = 2023		--Í¬ĞÄÖµÉÏÏŞid
function ma_same_heart_deal()
	---------------------------Í¬ĞÄÖµÉÏÏŞ´¦Àí---------------------------
	if GetTask(Same_heart_value_max_TaskID) <= 500 then
		SetTask(Same_heart_value_max_TaskID,500)
	end
	---------------------------Í¬ĞÄÖµË¥¼õ´¦Àí---------------------------
	local day_seq_dealed = GetTask(TaskID_attenuation_date_seq)
	local day_seq_now = zgc_pub_day_turn(1)
	--µÚÒ»´Î²»´¦Àí
	if day_seq_dealed == nil or day_seq_dealed == 0 then
		SetTask(TaskID_attenuation_date_seq,day_seq_now)
		return
	end
	--¼ÆËã²îÒìÌìÊı
	local day_distance = day_seq_now - day_seq_dealed
	if day_distance < 7 then
		return
	end
	--Í¬ĞÄÖµË¥¼õ
	local same_heart_value = GetTask(2015)
	local attenuation_num = 0
	if same_heart_value <= 500 then
		attenuation_num = (day_distance * 4)
	elseif same_heart_value >501 and same_heart_value <= 2000 then
		attenuation_num = floor(same_heart_value * (0.06/7) * day_distance)
	else
		attenuation_num = floor(same_heart_value * (0.12/7) * day_distance)
	end
	--¼ÇÈëµ±Ç°ÌìĞòÊı
	SetTask(TaskID_attenuation_date_seq,day_seq_now)
	--Èç¹ûË¥¼õÖµ´óÓÚµ±Ç°ÖµÔòÉèÖÃÎª0
	if same_heart_value <= attenuation_num then
		SetTask(TaskID_same_heart_value,0)
	else
		SetTask(TaskID_same_heart_value,(same_heart_value - attenuation_num))
	end
end
--ÁºÉ½¹Ø¿¨ºÍÌìÃÅÕóÉÏÏßÌáÊ¾
nTaskId_LS_TMS_TALK = 2856
tLsTmz_TALK_INFO = {
	{70,"Thiªn M«n TrËn: Nh»m t¨ng quy m« tham gia chiÕn tr­êng DiÔn Vâ Thiªn M«n TrËn, qu©n sÜ §¹i Tèng ®· më thªm chiÕn trËn diÔn vâ Thiªn M«n TrËn t¹i Thµnh §« (231, 229) vµ §¹i Lı (179,179) h·y ®Õn ®ã t×m Qu¸ch Qu©n B»ng b¸o danh tham gia"},
	{80,"Khiªu chiÕn L­¬ng S¬n: L­¬ng S¬n 108 vŞ t­íng göi lêi mêi ®Õn c¸c vŞ hµo kiÖt trªn giang hå ®Õn tû vâ giao h÷u, ®¹i hiÖp cã thÓ ®Õn c¸c thµnh chñ t×m Thµnh Hµnh Th¸i B¶o §íi T«ng (bªn c¹nh ThÇn Du Ch©n Nh©n) ®Ó ®­îc tham gia v­ît ¶i"},
}
function task_talk_deal()
	local nPlayerLevel = GetLevel()
	local nTalkValue = GetTask(nTaskId_LS_TMS_TALK)
	for i = 1,getn(tLsTmz_TALK_INFO) do
		if nPlayerLevel >= tLsTmz_TALK_INFO[i][1] and GetBit(nTalkValue,i) == 0 then
			LsTmz_login_talk(i)
			break
		end
	end
end
function LsTmz_login_talk(nTalkSeq)
	Talk(1,"#LsTmzTalkFinish("..nTalkSeq..")",tLsTmz_TALK_INFO[nTalkSeq][2])
end
function LsTmzTalkFinish(nTalkSeq)
	local nTalkValue = GetTask(nTaskId_LS_TMS_TALK)
	nTalkValue = SetBit(nTalkValue,nTalkSeq,1)
	SetTask(nTaskId_LS_TMS_TALK,nTalkValue)
end
--==================================½áÊø=================================

--========================07ÆßÏ¦»î¶¯======================================
--Í³¼ÆÔÚÏßÊ±¼ä£¬²¢Ôö¼Ó³É³¤¶È
function flower_time()
	--Ã»ÖÖ»¨²»Í³¼Æ
	if GetTask(TASK_IS_PLANT) == 0 then
		return
	end
	--³É³¤¶Èµ½100²»ÔÙÍ³¼Æ
	if GetTask(TASK_FLOWER_GROW) >= 100 then
		return
	end
	--µ±Ìì³É³¤¶ÈÒÑ¾­¼Ó1£¬²»ÔÙÍ³¼Æ
	local now_days = floor((GetTime()+28800)/86400);
	if now_days == GetTask(TASK_IS_GROW) then
		return
	end

	if GetTask(TASK_LAST_LOGIN) ~= GetLastLoginTime()+28800 then   --ÅĞ¶ÏÊÇ·ñ¿ç·ş
		SetTask(TASK_CURRENT_LOGIN,GetTime()+28800);  --¼ÇÂ¼µ±Ç°µÇÂ½Ê±¼ä
		SetTask(TASK_LAST_LOGIN,GetLastLoginTime()+28800);
	else                     --¿ç·şÒ²²»Í³¼Æ
		return
	end

	local nThisTime = floor(GetTask(TASK_CURRENT_LOGIN)/86400);
	local nLastTime = floor((GetLastLoginTime()+28800)/86400);
	if nLastTime ~= 0 and nThisTime ~= nLastTime then
		SetTask(TASK_TOTAL_TIME,0);
	end
end
--==========================================================================================
function process_biwudahui()
	StopTimeGuage(-1);
	local nVersion,nCurGs = GetRealmType();
	if nCurGs == 1 then
		SetFightState(0);
--		if GetSvrConfig("IsSaveRoleData") == 0 then
--			Del_Item_By_List();
--			Add_Item_By_List(g_tGiveItemList);
--			Del_Spe_Item();
--			--ÒøÈ¯´¦Àí£º¿ç·şÇøÏÈ¸ÉµôÒøÈ¯
--			local nValue = GetYinQuan();
--			ModifyYinQuan(-nValue);
--			Msg2Player("ÒøÈ¯ÊıÁ¿ÔÚ·µ»ØÔ­·şºó»Ö¸´£¡");
--		end
		ForbidChangePK(1);
		ForbitTrade(1);	--½ûÖ¹½»Ò×
		StallEnable(0);	--½ûÖ¹°ÚÌ¯
		local nMap_ID = GetWorldPos();
		local tDLGC_Map = {};
		if _JX2WZ ~= 2 then
			tDLGC_Map = {
				[7990] = 1,
				[7991] = 1,
				[7992] = 1,
				[7993] = 1,
				[7994] = 1,
			};
		else
			tDLGC_Map = {
				[7990] = 1,
				[7991] = 1,
				[7992] = 1,
			};
		end
		if nMap_ID == 7100 then --±ÈÎä´ó»á
			SetTask(TSK_JOIN_LIST_TYPE,-1,TASK_ACCESS_CODE_BIWUDAHUI);
			JoinGestConvention();
			RemoveRevivals();	--Çå³ıÎå¶¾±¦±¦
			SetTask(TSK_JOIN_LIST,1,TASK_ACCESS_CODE_BIWUDAHUI);
			Add_Item_By_List(g_tGiveItemList_biwu)
		elseif nMap_ID == 7980 then --¿ç·şÌìÃÅÕó
			Add_Item_By_List(g_tGiveItemList_tmz_dlgc)
		elseif nMap_ID == 8000 then	-- NVN
--			NvnHall_Enter();
--			SendScript2Client(format("Open('nvnHall', %d)",1));
--			NVN_UpdateItemEnhance();
			Add_Item_By_List(g_tGiveItemList_biwu)
			P3v3_Join();
			SendScript2Client("Open('3v3')");
--		elseif tDLGC_Map[nMap_ID] == 1 then --´ïÂ³¹Å³Ç±¨Ãû´¦
--			Add_Item_By_List(g_tGiveItemList_tmz_dlgc)
--			DLGC_Join();
--			SendScript2VM("\\script\\missions\\dlgc\\dlgc_sign_up.lua", "onPlayerLogin()");
--			--SendScript2Client("Open('DLGCBattle')");
--			WriteLog(format("[date:%s][role:%s][acc:%s][´ïÂ³¹Å³ÇµÇÂ¼±¨Ãû³¡µØ][GSID:%d]",date("%Y%m%d%H%M%S"),GetName(),GetAccount(), GetGSIndex()[0]));
--		elseif nMap_ID == 7102 then
--			SetTask(TASKID_XSBK_ENTER_TIME, GetTime());
--			local nMinute = tonumber(date("%M"));
--			local nSecond = tonumber(date("%S"));
--			local nDeltaTime = (40 - nMinute) * 60 + nSecond;
--			if nDeltaTime > 0 then
--				StartTimeGuage("Î÷É½±¦¿âµ¹¼ÆÊ±", nDeltaTime, 0, 1);
--			end
--			local szMsg = "Ê§ÂäÑÂµÄÎ÷É½±¦¿â»î¶¯½«ÓÚ" .. date("%H") .. "µã40·ÖÕıÊ½¿ªÊ¼£¬ÏÀ¿ÍÇëÔÚ´ËµÈ´ıÇøÓòÄÍĞÄµÈºò¡£";
--			Talk(1, "", szMsg);
--			Msg2Player(szMsg);
		end
		--Íâ×°ÔÌÁé£º¿ç·şÇø²»¸øÇ§±äºĞ
--		local nQBHCount = BigGetItemCount(2,95,572);
--		if nQBHCount > 0 then
--			BigDelItem(2,95,572,nQBHCount);
--		end
		--¼¼ÄÜÊ¯½õÄÒ
--		local nJNSCount = BigGetItemCount(2,1,10010);
--		if nJNSCount > 0 then
--			BigDelItem(2,1,10010,nJNSCount);
--		end
	else
		--Ç§±äºĞ
--		local nQBHCount = BigGetItemCount(2,95,572);
--		if nQBHCount < 1 then
--			AddItem(2,95,572,1);
--		end
		--¼¼ÄÜÊ¯½õÄÒ
--		if 0 >= BigGetItemCount(2,1,10010) then
--		AddItem(2,1,10010,1,4);
--		end
	
		SendScript2Client(format("Open('nvnHall', %d)",0));
		SendScript2Client(format("Open('nvnRoom', %d)",0));
		local nNowDate = tonumber(date("%Y%m%d%H"));
		if nNowDate < g_nBWAwardDate then
			Msg2Player("Ph¸t th­ëng §¹i Héi Tû Vâ liªn ®Êu, tõ 10 giê 12/05/2014 ®Õn 22 giê 18/05/2014 cã thÓ ®Õn ®Æc sø §¹i Héi Tû Vâ nhËn th­ëng.");
		end
--		if GetTask(TASKID_BIWU_IS_REALM) ~= 0 then
--			GLB_BW_SynData(0,0);--Í¬²½Êı¾İ
--			local nRoute = GetPlayerRoute();
--			if nRoute == 21 then
--				GLB_BW_SynData(0,1);
--			end
--			GLB_BW_SynData(0,2);
--			GLB_BW_SynData(0,3);
--		else
			process_biwudahui_update_zige()
			process_biwudahui_2()
--		end
	end
end;

function process_biwudahui_2()
	--SetTask(TASKID_BIWU_IS_REALM,0);
	g_tZiGePoint = {};
	local nCurPoint = GetTask(666);
	local nSignUpInfo = GetTask(678);
	local nBeginTime = MkTime(2014,5,12,10,0,0);
	local nCurTime = GetTime();
	local nWeek = ceil((nCurTime-nBeginTime)/(7*24*3600));
	local nCurSeason = ceil(nWeek/g_nBWWeeks); --µÚ¼¸Èü¼¾
	local nSeasonWeek = mod(nWeek,g_nBWWeeks); --µ±Ç°Èü¼¾µÄµÚ¼¸ÖÜ
	if nSeasonWeek == 0 then
		nSeasonWeek = g_nBWWeeks;
	end
	local nCurWeek = tonumber(date("%w"));
	nBeginTime = nBeginTime+(nCurSeason-1)*g_nBWWeeks*7*24*3600;

	if nCurTime >= nBeginTime and GetTask(649) ~= nBeginTime then
		if BWDH_DEBUG_VERSION == 1 then
			print("biwudahui new season:", GetName(), nCurTime, GetTask(649));
		end
		SetTask(647,nSignUpInfo, TASK_ACCESS_CODE_BIWUDAHUI);	--¼ÇÂ¼ºÏ²¢Ç°µÄ±¨ÃûÇé¿ö
		if nSignUpInfo ~= 0 then	--±¨¹ıÃûµÄÍæ¼Ò
			if nSignUpInfo == 1 then	--Èç¹ûÊÇĞÂĞã±ÈÎä´ó»áÑ¡ÊÖ
				SetTask(678,2);
			end;
			if nCurPoint < 200 then	--Ö»¸ø200·ÖÒÔÏÂµÄÍæ¼ÒÔö¼Ó»ı·Ö
				if nCurPoint + 100 > 200 then
					SetTask(666,200,TASK_ACCESS_CODE_BIWUDAHUI);
					Msg2Player("§iÓm tû vâ ®· t¨ng"..(200 - nCurPoint).." Phót ");
				else
					SetTask(666,nCurPoint+100,TASK_ACCESS_CODE_BIWUDAHUI);
					Msg2Player("§iÓm tû vâ ®· t¨ng 100 ®iÓm");
				end;
			end;
			SetTask(646,GetTask(662),TASK_ACCESS_CODE_BIWUDAHUI);	--¼ÇÂ¼ºÏ²¢Ç°µÄ×Ê¸ñ»ı·Ö
			SetTask(TSK_SEASON_ZIGE_LAST,GetTask(662),TASK_ACCESS_CODE_BIWUDAHUI); --¼ÇÂ¼ÉÏÈü¼¾µÄ×Ê¸ñ»ı·Ö
			SetTask(662,0,TASK_ACCESS_CODE_BIWUDAHUI);	--×Ê¸ñ»ı·ÖÇå0
			Msg2Player("§iÓm t­ c¸ch ®· xãa 0");
			local nLevel = GetLevel();
			local nRoute = GetPlayerRoute();
			if not bInit then
				ApplyRelayShareData("GestConvention_Zige_Last", nLevel, nRoute, g_szThisFile, "gc_zige_point_callback");
			else
				local nPlayerName = GetName();
				if GetTask(TSK_SEASON_ZIGE_LAST) < g_tZiGePoint[nPlayerName] then
					SetTask(TSK_SEASON_ZIGE_LAST,g_tZiGePoint[nPlayerName],TASK_ACCESS_CODE_BIWUDAHUI);
				end
			end
		end;
		SetTask(649,nBeginTime,TASK_ACCESS_CODE_BIWUDAHUI);
	end;

	--¶ÔÓÚ´óÓÚµ±Ç°ÖÜ×î¸ß×Ê¸ñ·ÖµÄ½øĞĞ´¦Àí
	if nCurWeek ~= 0 and nCurWeek ~= 1 then --ĞÇÆÚÌìºÍĞÇÆÚÒ»¶¼²»½øĞĞ´¦Àí
		local nMaxPoint = (nSeasonWeek-1)*100;
		if GetTask(662) > nMaxPoint then
			SetTask(662,nMaxPoint,TASK_ACCESS_CODE_BIWUDAHUI);
			SignUpGestResult();	--½«»ı·ÖÇ¿ÖÆµÇ¼ÇÉÏÈ¥
			Msg2Player("Do t­ c¸ch tham dù §¹i Héi Tû Vâ cña b¹n kh«ng hîp lÖ, nay ®· söa vµ ®¨ng kı l¹i.");
		end
	end

	if GetTask(673) == 1 then	--Èç¹û±¨Ãû²Î¼ÓÁË½ÏÒÕ
		JoinGestConvention();
	end;
	nCurPoint = GetTask(666);
	if GetTask(674) ~= 0 then	--Ñ¡Ôñ¹ı³ÌÖĞÏÂÏßÁË£¬ÉÏÏßÊ±µ±¾Ü¾ø±ÈÎä´¦Àí
		SetTask(666,nCurPoint-2,TASK_ACCESS_CODE_BIWUDAHUI);
		Say("Tõ chèi tû vâ, trõ 2 ®iÓm so tµi",0);
		SetTask(674,0,TASK_ACCESS_CODE_BIWUDAHUI);
		Msg2Player("Tõ chèi tû vâ, trõ 2 ®iÓm so tµi");
	end;
	
	SendScript2VM("\\script\\biwudahui\\tournament\\tournament_function.lua", "BWT_WeeklyClear()")
	--==ÏÂÃæµÄ´úÂëÒªºÍBWT_WeeklyClearµÄ¹¦ÄÜÒ»Ñù
--	local nWeekNum = GetPlayerBwRank();
--	local nBodyWeek = GetTask(680);
--	if nWeekNum == -1 then	--Relay¹ÒÁË
--		return 0;
--	end;
--	if nBodyWeek - nWeekNum >= 1 then	--ºÏ·şºónWeekNum»á´Ó0¿ªÊ¼
--		SetTask(680,nWeekNum-1,TASK_ACCESS_CODE_BIWUDAHUI);	--Í¬²½Íæ¼ÒÉíÉÏµÄÖÜÊı
--		SetTask(676,nWeekNum-1,TASK_ACCESS_CODE_BIWUDAHUI);	--Í¬²½Íæ¼ÒÁìÈ¡½±ÀøµÄÖÜÊı
--		nBodyWeek = nWeekNum-1;
--	end;
--	
--	if BWDH_DEBUG_VERSION == 1 then
--		print("biwudahui weekly check:", GetName(), nBodyWeek, nWeekNum);
--	end
--	if nBodyWeek < nWeekNum then
--		process_bw_point_attenuation();
--		SetTask(667,0,TASK_ACCESS_CODE_BIWUDAHUI);	--±¾ÖÜ×Ü²ÎÓë³¡´Î
--		SetTask(668,0,TASK_ACCESS_CODE_BIWUDAHUI);		--±¾ÖÜÊ¤Àû³¡´Î
--		SetTask(669,0,TASK_ACCESS_CODE_BIWUDAHUI);		--±¾ÖÜÊ§°Ü³¡´Î
--		SetTask(679,0,TASK_ACCESS_CODE_BIWUDAHUI);	--±¾ÖÜÍ¨¹ı½ÏÒÕ»ñµÃµÄĞÄµÃÊıÁ¿
--		SetTask(665,0,TASK_ACCESS_CODE_BIWUDAHUI);	--µÇ¼Ç»ı·ÖÇå0
--		SetTask(681,0,TASK_ACCESS_CODE_BIWUDAHUI);	--±¾ÖÜ»ñµÃÊµÕ½ĞÄµÃÇé¿öÇå0
--		SetTask(682,0,TASK_ACCESS_CODE_BIWUDAHUI);		--±¾ÖÜÊ¹ÓÃÊµÕ½ĞÄµÃÇå£°
--		SetTask(683,0,TASK_ACCESS_CODE_BIWUDAHUI);		--±¾ÖÜÂòÂíÇå£°
--		SetTask(685,0,TASK_ACCESS_CODE_BIWUDAHUI);	--Ê¹ÓÃ´«¹¦ĞÄµÃ
--		SetTask(640,0,TASK_ACCESS_CODE_BIWUDAHUI);	--±¾ÖÜ¶Ò»»µÄÕ½³¡½±Àø´ÎÊı
--		SetTask(687,0,TASK_ACCESS_CODE_BIWUDAHUI);		--±¾ÖÜ¶Ò»»µÄÊ¦ÃÅ½±Àø´ÎÊı
--		SetTask(642,0,TASK_ACCESS_CODE_BIWUDAHUI);		--±¾ÖÜ¶Ò»»µÄÁéÊ¯½±Àø´ÎÊı
--		SetTask(643,0,TASK_ACCESS_CODE_BIWUDAHUI);		--±¾ÖÜ¶Ò»»µÄ¾­Ñé½±Àø´ÎÊı
--		
--		SetTask(3219,0,TASK_ACCESS_CODE_BIWUDAHUI);		--Ç°10³¡µÄÊ¤Àû³¡´Î
--		SetTask(3220,0,TASK_ACCESS_CODE_BIWUDAHUI);		--Ç°10³¡µÄÊ§°Ü³¡´Î
--		SetTask(3221,0,TASK_ACCESS_CODE_BIWUDAHUI);		--ÊÇ·ñÁìÈ¡ÁËÇ°10³¡µÄ½±Àø
--		
----		SetTask(2732,0);
----		SetTask(2733,0);
----		SetTask(2734,0);
--		if GetTask(666) < 200 then
--			SetTask(666,200,TASK_ACCESS_CODE_BIWUDAHUI);	--µÍÓÚ100·ÖµÄ»Ø¹éµ½100·Ö
--		end;
--	end
	if GetTask(667) >= 10 then
		SetTask(665,GetTask(666),TASK_ACCESS_CODE_BIWUDAHUI);
		SignUpGestResult();	--½«»ı·ÖµÇ¼ÇÉÏÈ¥
	end
end

--¸üĞÂµ±Ç°Èü¼¾×Ê¸ñ·Ö
g_tZiGePointChange = {}
g_tZiGePointChangeInit = {}
function process_biwudahui_update_zige()
	local nLevel = 1 --GetLevel()
	local nRoute = GetPlayerRoute()
	if not g_tZiGePointChangeInit[nRoute] then
		ApplyRelayShareData("GestConvention_Change", nLevel, nRoute, g_szThisFile, "process_biwudahui_update_zige_cb")
	else
		process_biwudahui_update_zige_do_update()
	end
end

function process_biwudahui_update_zige_cb(szKey,nLevel,nRoute,nRecordCount)
	g_tZiGePointChangeInit[nRoute] = 1
	if nRecordCount == 0 then
		return 0
	end
	for i=1,nRecordCount do
		--·µ»ØÖµ£ºÍæ¼ÒÃû£¬×Ê¸ñ»ı·Ö
		szName,nPoint = GetRelayShareDataByIndex(szKey,nLevel,nRoute,i-1)
		g_tZiGePointChange[szName] = nPoint;
	end
	process_biwudahui_update_zige_do_update()
end

function process_biwudahui_update_zige_do_update()
	local nPlayerName = GetName()
	local nNewPoint = g_tZiGePointChange[nPlayerName] or 0
	if nNewPoint > 0 then
		local szScript = format("SyncZgPoint(%d)", nNewPoint)
		SendScript2VM("\\script\\global\\gest_convention_callback.lua", szScript)
	end
end


function GLB_BW_Return_Tb(...)
	local nReturnTb = {};
	for i=1,arg.n do
		tinsert(nReturnTb,arg[i]);
	end
	return nReturnTb
end

--¿ç·ş±ÈÎäÍ¬²½Êı¾İ
function GLB_BW_SynData(nkey1,nkey2)
	local strName = GetName();
	strName = "Realm_"..strName;
	ApplyRelayShareData(strName,nkey1,nkey2,g_szThisFile,"GLB_BW_Syn_CB");
end

function GLB_BW_Syn_CB(strName,nkey1,nkey2)
	local TbList = {};
	local strItemKey,strPrefix = "","";
	local tGushiTask = {--¹ÆÊ¦µÄ±äÁ¿
		2204,2216,2207,2222,2219,2210,2228,2213,2225,2231
	};

	if nkey1 == 0 and nkey2 == 1 then --¹ÆÊ¦
		--2012-08-01 ¾ö¶¨²»ÔÙÍ¬²½¹ÆÊ¦
--		TbList = GLB_BW_Return_Tb(GetRelayShareDataByKey(strName,nkey1,nkey2,"GS"));
--		if getn(TbList) < 2 then
--			return 0;
--		end
--		for i = 1,getn(TbList) do
--			if tGushiTask[i] ~= nil or tGushiTask[i] ~= 0 then
--				SetTask(tGushiTask[i],TbList[i]);
--			end
--		end
	elseif nkey1 == 0 and nkey2 == 2 then --åĞÒ£±Ò
		local nValue = GetRelayShareDataByKey(strName,nkey1,nkey2,"XYB");
		if nValue == nil or nValue < 0 then
			return 0;
		end
		PayXYB(nValue);
		SetTask(TASKID_XOYO_CONSUME,0);
		WriteLog(format("[Xu Tiªu Dao] [Role:%s Acc:%s] [Tèn Xu Tiªu Dao  %d]", GetName(), GetAccount(), nValue));
	elseif nkey1 == 0 and nkey2 == 3 then --åĞÒ£Óñ
		local nValue = GetRelayShareDataByKey(strName,nkey1,nkey2,"XYY");
		if nValue == nil or nValue < 0 then
			return 0;
		end
		PayXYY(nValue);
		SetTask(TASKID_XOYOYU_CONSUME,0);
		WriteLog(format("[Tiªu Dao Ngäc] [Role:%s Acc:%s] [Tèn Tiªu Dao Ngäc  %d]", GetName(), GetAccount(), nValue));
	else
		if nkey1 == 0 then 			--±ÈÎä´ó»á
			strPrefix = "BW";
		elseif nkey1 == 1 then 		--ÌìÃÅÕó
			strPrefix = "TMZ";
		elseif nkey1 == 2 then		--´ïÂ³¹Å³Ç
			strPrefix = "DLGC";
		end
		for i = 1,500 do
			strItemKey = strPrefix..tostring(i);
			TbList = GLB_BW_Return_Tb(GetRelayShareDataByKey(strName,nkey1,nkey2,strItemKey));
			if getn(TbList) < 2 then
				break;
			end
			for i=1,getn(TbList),2 do
				if TbList[i] ~= 0 and TbList[i+1] ~= nil then
					SetTask(TbList[i],TbList[i+1]);
				end
			end
		end
		process_biwudahui_2();
	end
	DelRelayShareDataCopy(strName,nkey1,nkey2)
	ClearRelayShareData(strName,nkey1,nkey2,g_szThisFile,"GLB_BW_Clear_callback")

	--³É¾Í----------------------------
	local nWinNum = GetTask(TASKID_ACH_BIWU_WIN_TOTAL);
	if nWinNum > 0 then
		SetTask(3712,nWinNum);
		OnAchEvent(2,3712);
	end
	local nUseNewRoute = GetTask(TASKID_ACH_USE_NEW_ROUTE);
	local nWinNewRoute = GetTask(TASKID_ACH_WIN_NEW_ROUTE);
	if nUseNewRoute > 0 then
		SetTask(3738,nUseNewRoute);
		OnAchEvent(2,3738);
	end
	if nWinNewRoute > 0 then
		SetTask(3739,nWinNewRoute);
		OnAchEvent(2,3739);
	end
	--³É¾ÍÀïÃæµÄÌìÃÅÕó
	OnAchEvent(2,3740);
	OnAchEvent(2,3741);
	OnAchEvent(2,TASKID_TMZ_TOTAL_WIN_NUM);
	
	------------------add by wangjing----------------
	--¿ç·ş³É¾Í±äÁ¿Í¬²½»ØÀ´ÔÙ´¥·¢
	for i = TASKID_TMZ_SPE_ACH_TASK_1, TASKID_TMZ_SPE_ACH_TASK_10 do		--ÌìÃÅÕóÏà¹Ø
		OnAchEvent(2, i);
	end
	
	for i = TASKID_DLGC_SPE_ACH_TASK_1, TASKID_DLGC_SPE_ACH_TASK_15 do		--´ïÂ³¹Å³ÇÏà¹Ø
		OnAchEvent(2, i);
	end
	-------------------------------------------------
	local award_3v3 = GetTask(TASKID_3V3_WIN_AWARD_COUNT);
	if award_3v3 > 0 then
		SetTask(TASKID_3V3_WIN_AWARD_COUNT, 0);
		soul_GivePoint(award_3v3 * 30);
	end
end

function GLB_BW_Clear_callback(strName,nkey1,nkey2)

end

function gc_zige_point_callback(szKey,nLevel,nRoute,nRecordCount)
	if nRecordCount == 0 then
		return 0;
	end;
	local nPlayerName = GetName();
	for i=1,nRecordCount do
		--·µ»ØÖµ£ºÍæ¼ÒÃû£¬×Ê¸ñ»ı·Ö£¬Á÷ÅÉ£¬µÈ¼¶£¬×ÜÊ¤£¬×Ü¸º£¬ÖÜÊ¤£¬ÖÜ¸º
		szName,nPoint = GetRelayShareDataByIndex(szKey,nLevel,nRoute,i-1);
		g_tZiGePoint[szName] = nPoint;
	end;
	if GetTask(TSK_SEASON_ZIGE_LAST) < g_tZiGePoint[nPlayerName] then
		SetTask(TSK_SEASON_ZIGE_LAST,g_tZiGePoint[nPlayerName]);
	end
	bInit = 1;
end

--function process_bw_point_attenuation()
--	local nWeekNum,nBWLevel,nBWRank = GetPlayerBwRank();
--	if nWeekNum == -1 then	--Relay¹ÒÁË
--		return 0;
--	end;
--	local nBodyWeek = GetTask(680);
--	if nBodyWeek >= nWeekNum then
--		return 0;
--	end;
--	local nCurPoint = GetTask(666);
--	local nWeekElapse = nWeekNum - nBodyWeek;
--	local nAttenPoint = get_bw_attenuation_point(nCurPoint,nWeekElapse);
--	if nCurPoint-nAttenPoint > 0 then
--		Msg2Player("§iÓm tİch lòy tû vâ gi¶m"..(nCurPoint-nAttenPoint).." ®iÓm");
--	end;
--	SetTask(666,nAttenPoint,TASK_ACCESS_CODE_BIWUDAHUI);
--	SetTask(680,nWeekNum,TASK_ACCESS_CODE_BIWUDAHUI);
--	SetTask(661,0,TASK_ACCESS_CODE_BIWUDAHUI);	--Ë¥¼õÊ±ÇåµôÉÏÖÜÅÅÃû
--	if nBWRank ~= -1 and nBWRank <= 10 then	--Èç¹û½øÈëÁËÅÅĞĞ°ñ
--		SetTask(661,nBWRank,TASK_ACCESS_CODE_BIWUDAHUI);
--		local nBestWeekRank = GetTask(663);
--		if nBestWeekRank == 0 or nBWRank < nBestWeekRank then
--			SetTask(663,nBWRank,TASK_ACCESS_CODE_BIWUDAHUI);	--×î¸ßÖÜÅÅÃû
--		end;
--	end;
--	WriteLog("[§¹i héi tû vâ]:"..GetName().."±§iÓm tİch lòy tû vâ gi¶m. Tr­íc lóc gi¶m:º"..nCurPoint..", sau khi gi¶m:º"..nAttenPoint);
--end;

function get_bw_attenuation_point(nPoint,nWeek)
	if nPoint <= 300 then
		return nPoint;
	end;
	for i=1,nWeek do
		if nPoint <= 300 then
			break;
		else
			nPoint = nPoint - floor((nPoint-300)/2);
		end;
	end;
	return nPoint;
end;
--===================================================================================

--ÔùËÍÎ÷ÓòÌ½ÃØÃÅÆ±
function give_xibei_ticket()

local msg_list = {
	[1] = "Cæ D­¬ng Thó ®· trèn vÒ Cæ D­¬ng §éng, C«n L«n Mai BÊt Dung kh«ng nhÉn t©m nh×n Cæ D­¬ng Thó bŞ tra tÊn ®Õn chÕt, muèn t×m ng­¬i gióp ®ì, ®Õn C«n L«n t×m c« ta ®i.",
	[2] = "ChuyÖn ng­¬i t×m M« Kim Phï cho LiÔu Tung V©n thËt kú l¹, bİ mËt cña TÇn L¨ng d­êng nh­ kh«ng ®¬n gi¶n, LiÔu Tung V©n ë Phông T­êng ®ang t×m ng­¬i gióp ®ì.",
	[3] = "T­ M· Minh Phong biÕt bİ mËt TÇn L¨ng, muèn ®i giÕt Quû T­íng Qu©n ®Ó t×m tung tİch cña vî y, nªn ®Õn ®ã gióp ®ì.",
	[4] = "T«n Ph­¬ng Nh©n ®i d¹o D­îc V­¬ng §éng, ph¸t hiÖn nhiÒu D­îc Nh©n Th¶o, cho r»ng D­îc V­¬ng chuÈn bŞ t¸i sinh, muèn ng­¬i gióp diÖt trõ tËn gèc.",
	[5] = "Lı Nguyªn Kh¸nh kh«ng tõ mäi thñ ®o¹n ®Ó giÕt Th¸c B¹t Ho»ng, ng­¬i còng cã trong danh s¸ch, mau ®Õn Phông T­êng t×m Th¸c B¹t Ho»ng ®i.",
	[6] = "Long M«n TrÊn bŞ b·o c¸t ®i qua, ®Ó l¹i c¶nh t­îng hoang tµn, ®æ n¸t, T«n NhŞ Liªn ®i qua ®i l¹i kh«ng biÕt lµm g×, tr«ng cã vÎ u sÇu, ng­¬i ®Õn ®ã hái thö xem.",
	}
local i = random(1,100);
local t = 0;

	--50%¼¸ÂÊ¸øÓèÌáÊ¾£¬Ã¿´ÎÖ»ÌáÊ¾Ò»¸öÃÅÆ±ÔùËÍĞÅÏ¢
	if i > 50 then
		for t=1,6 do
			if GetBit(GetTask(2038),t) ~= 1 then
				Msg2Player(msg_list[t])
				break;
			end
		end
	end

end

function go_to_biwudahui()
	NewWorld(200,1391,2821);	--Èç¹ûNewWorldÊ§°Ü£¬Ôò»áÔÚÏÂÒ»Ö¡»Ö¸´Ô­ÏÈµÄÕ½¶·×´Ì¬
	SetFightState(0);
end;

function nothing()

end;

function about_suohun()
	Say("<color=red>Chó ı:<color>:\nVËt phÈm khãa hån sÏ xuÊt hiÖn th«ng tin <color=red>së h÷u: 'Tªn ng­êi ch¬i'<color>, vËt phÈm sau khi khãa hån, nh©n vËt ®ã sÏ cã quyÒn së h÷u vËt phÈm nµy, mét khi ph¸t hiÖn vËt phÈm bŞ r¬i mÊt, hÖ thèng phôc vô sÏ dùa vµo ®ã ®Ó ph©n ®Şnh.\nDo ®ã, khi ®ang giao dŞch, vËt phÈm cã th«ng tin <color=red>së h÷u: 'Tªn ng­êi ch¬i'<color>, nÕu kh«ng ph¶i cho m­în, ch¾c ch¾n kh«ng nªn giao dŞch.",
		1,
		"Ta ®· hiÓu/nothing");
	SetTask(544,1);
end

function process_shimenguanka()
	if GetTask(1124) == 0 then	--Èç¹ûÊÇµ÷ÕûºóµÚ1´ÎµÇÂ½
		SetTask(1127,0);	--±¾ÖÜ´³¹ØÊ§°Ü´ÎÊı£¨Çåµµ´ÎÊı£©Çå0
		SetTask(1124,1);
	end;
end;

function process_ip_issue()
	local nLastLoginIp,nCurrentLoginIp = GetLoginIP();
	if nLastLoginIp ~= nCurrentLoginIp and nLastLoginIp ~= 0 then
		local nLIP1,nCIP1 = floor(nLastLoginIp/2^24),floor(nCurrentLoginIp/2^24);
		local nLIP2,nCIP2 = floor((nLastLoginIp-nLIP1*2^24)/2^16),floor((nCurrentLoginIp-(nCIP1*2^24))/2^16);
		local nLIP3,nCIP3 = floor((nLastLoginIp-nLIP1*2^24-nLIP2*2^16)/2^8),floor((nCurrentLoginIp-nCIP1*2^24-nCIP2*2^16)/2^8);
		local nLIP4,nCIP4 = nLastLoginIp-nLIP1*2^24-nLIP2*2^16-nLIP3*2^8,nCurrentLoginIp-nCIP1*2^24-nCIP2*2^16-nCIP3*2^8;
		local szLIP = tostring(nLIP1.."."..nLIP2.."."..nLIP3.."."..nLIP4);
		local szCIP = tostring(nCIP1.."."..nCIP2.."."..nCIP3.."."..nCIP4);
--		Talk(1,"","ÄúÉÏ´ÎµÇÂ¼ÓÎÏ·µÄIPÊÇ£º<color=yellow>"..szLIP.."<color>£¬±¾´ÎµÇÂ¼ÓÎÏ·µÄIPÊÇ£º<color=yellow>"..szCIP.."<color>£¬<color=red>Á½´ÎµÇÂ¼IP²»Í¬<color>£¬Çë¼ì²éÊÇ·ñÓĞÒì³££¬Èç¹ûÕâÁ½´ÎµÇÂ½²¢²»ÊÇÄú±¾ÈËµÄ²Ù×÷£¬ÄÇÃ´ÄúµÄÃÜÂëºÜ¿ÉÄÜÒÑ¾­Ğ¹Â©£¬Çë¾¡¿ìÓÃ°ó¶¨ÊÖ»ú»ò°ó¶¨ÓÊÏäĞŞ¸ÄËùÓĞÃÜÂë¡£Èç¹ûÈ·ÈÏ±»µÁ£¬Çë¼´¿Ì´ò¿ª<color=yellow>F1<color>µÇÂ½<color=red>[±»µÁ×ÔÖú´¦ÀíÔÚÏßÏµÍ³]<color>½øĞĞÉÏ±¨¡£´ËÏµÍ³Ö»ÊÜÀí±»µÁ3ÌìÄÚµÄÎÊÌâ£¬´¦ÀíÊ±¼äÎª1-5¸ö¹¤×÷ÈÕ¡£");
		Msg2Player("IP ®¨ng nhËp lÇn tr­íc lµ:"..szLIP..", IP ®¨ng nhËp lÇn nµy lµ:"..szCIP..", IP ®¨ng nhËp kh¸c nhau, xin kiÓm tra l¹i, chó ı an toµn tµi kho¶n.");
	end;
end;
--Í¬²½¹ÆÊ¦¹Æ¶¦ÀïÃæµÄ¹ÆµÄÊıÁ¿¸ø¿Í»§¶Ë
function sync_guinsect_num_in_guding()
	for i=1,40 do
		SyncGuInsectNumInGuDing(i,GetTask(2200+i));
	end;
end;


-- ÒÔÏÂ¼¸¸öÈÎÎñ±äÁ¿ÔÚ\script\global\offlinelive_action.luaÖĞ¶¨Òå£¡£¡
TASKVAL_BAIJU_LASTACTIVE_TIME = 2292		-- ¼ÇÂ¼×î½üÒ»´Î»ñµÃ°×¾Ô¾­ÑéµÄÊ±¼ä
TASKVAL_LIUSHEN_LASTACTIVE_TIME = 2293		-- ¼ÇÂ¼×î½üÒ»´Î»ñµÃÁùÉñ¾­ÑéµÄÊ±¼ä
TASKVAL_SANQING_LASTACTIVE_TIME = 2294		-- ¼ÇÂ¼×î½üÒ»´Î»ñµÃÈıÇå¾­ÑéµÄÊ±¼ä

TASKVAL_BAIJU_OFFLINE_TIME = 2295			-- ÀëÏß°×¾ÔÊ±¼ä£¨ÀÛ»ı£©·ÖÖÓ
TASKVAL_LIUSHEN_OFFLINE_TIME = 2296			-- ÀëÏßÁùÉñÊ±¼ä£¨ÀÛ»ı£©·ÖÖÓ
TASKVAL_SANQING_OFFLINE_TIME = 2297			-- ÀëÏßÈıÇåÊ±¼ä£¨ÀÛ»ı£©·ÖÖÓ

TIME_ZONE_OFFSET_SEC = 8 * 3600

-- ÀëÏßµÄÀëÏßÍĞ¹Ü
function OfflineLiveEx()
	local LogoutTime = GetLastLogoutTime()
	if LogoutTime == 0 then		-- ĞÂ½¨ÕÊºÅ
		return
	end

	LogoutTime = LogoutTime - TIME_ZONE_OFFSET_SEC
	local LoginTime = GetTime()
	local PlayerCreateTime = GetCreateTime()
	local MaxOfflineTime = LoginTime - PlayerCreateTime
	local nMaxTime = floor(MaxOfflineTime / 60)
	
	local nBaiJuTime = UpdateOneOfflineTime(LogoutTime, LoginTime, nMaxTime, TASKVAL_BAIJU_LASTACTIVE_TIME, TASKVAL_BAIJU_OFFLINE_TIME, 0)
	local nLiuShenTime = UpdateOneOfflineTime(LogoutTime, LoginTime, nMaxTime, TASKVAL_LIUSHEN_LASTACTIVE_TIME, TASKVAL_LIUSHEN_OFFLINE_TIME, 0)
	local nSanQingTime = UpdateOneOfflineTime(LogoutTime, LoginTime, nMaxTime, TASKVAL_SANQING_LASTACTIVE_TIME, TASKVAL_SANQING_OFFLINE_TIME, 0)
	local nJuLingTime = UpdateJuLingOfflineTime(LogoutTime, LoginTime, nMaxTime)
	
	_TellOfflineTime(nBaiJuTime, nLiuShenTime, nSanQingTime, nJuLingTime)
end

function _TellOfflineTime(nBaiJuTime, nLiuShenTime, nSanQingTime, nJuLingTime)
	if nBaiJuTime > 0 or nLiuShenTime > 0 or nSanQingTime > 0 or nJuLingTime > 0 then
		
		local PlayerLevel = GetLevel()
    	local GiveExpPerMin = 0
    	if PlayerLevel >= 90 then
    		GiveExpPerMin = 5000
    	else
    		GiveExpPerMin = ceil(PlayerLevel * PlayerLevel / 2)
    	end
    	local GiveExp = GiveExpPerMin * nBaiJuTime * 2
    	
		local szMsg = "C¸c h¹ ®· tÜnh lòy ®­îc \n"
    	szMsg = format("%s %s thêi gian rêi m¹ng B¹ch C©u hoµn, cã thÓ ®æi tèi ®a <color=yellow>%s<color> ®iÓm kinh nghiÖm\n", szMsg, _GetTimeStr(nBaiJuTime), get_large_num(GiveExp))
    	szMsg = format("%s %s thêi gian Lôc ThÇn Hoµn, cã thÓ quy ®æi ®­îc nhiÒu nhÊt <color=yellow>%d<color> ®iÓm danh väng\n", szMsg, _GetTimeStr(nLiuShenTime), floor(nLiuShenTime/2))
    	szMsg = format("%s %s thêi gian Tam Thanh Hoµn, cã thÓ quy ®æi ®­îc nhiÒu nhÊt <color=yellow>%d<color> ®iÓm cèng hiÕn s­ m«n\n", szMsg, _GetTimeStr(nSanQingTime), floor(nSanQingTime * 3 / 20))
    	szMsg = format("%s %s thêi gian Tô Linh Hoµn, cã thÓ quy ®æi ®­îc nhiÒu nhÊt <color=yellow>%d<color> ®iÓm ch©n khİ\n", szMsg, _GetTimeStr(nJuLingTime),3*nJuLingTime)
    	szMsg = format("%s cã thÓ dïng thêi gian ñy th¸c t­¬ng øng ®Ó quy ®æi thµnh ®iÓm th­ëng cÇn thiÕt.", szMsg)
    	Say(szMsg, 0)
--    	local tbDialog = {
--    		"ÎÒÖªµÀÁË/no_say",
--    		};
--    	Say(szMsg, getn(tbDialog), tbDialog)
	end
end

function get_large_num(nNum)
	local nLarge = floor(nNum / (10000*10000))
	local nLeft = mod(nNum , (10000*10000))
	local szStr = ""
	if nLarge > 0 then
		szStr = format("%d", nLarge)
	end
	szStr = format("%s%d", szStr,nLeft)
	return szStr
end

function goto_getthose()
	NewWorld(350,1433,2769)
	SetFightState(0)
end

--½»Ò××Ô¶¯Ëø¶¨
function com_auto_lock()
--	if GetTask(827) == 0 and GetLevel() >= 60 then
--		Say("    Äú»¹Ã»ÓĞ¿ªÆô[½»Ò××Ô¶¯Ëø¶¨]¹¦ÄÜ£¬Ç¿ÁÒ½¨ÒéÄú¿ªÆô´Ë¹¦ÄÜ¡£´Ë¹¦ÄÜ¿ªÆôºó½«ÔÚÄúµÄµÇÂ½IP±ä»¯Ê±×Ô¶¯½øÈë[½»Ò×±£»¤Ê±¼äÆÚ]£¬Õâ¿ÉÒÔ¸üÓĞĞ§µÄ±£»¤ÄúµÄ²Æ²ú°²È«£º\nÇé¿öÒ»£º·ÀÖ¹µÁºÅÄ¾Âí¶ñÒâÌßºÅºóµÇÂ½²¢×ªÒÆÄúµÄ²ÆÎï¡£\nÇé¿ö¶ş£ºµ±Ç°Ê£Óà½»Ò×Ëø¶¨Ê±¼äĞ¡ÓÚ×Ô¶¯Ëø¶¨ÉèÖÃÊ±¼äÊ±£¬×Ô¶¯ĞŞÕı×îĞ¡½»Ò×±£»¤Ê±¼ä£¡",2,"\nÎÒÏÖÔÚ¾ÍÒª¿ªÆôÊ¹ÓÃ´Ë¹¦ÄÜ/func_2_auto","\nÎÒÖªµÀÁË/no_say");
--	else
--	end;
end;


function no_say()
end


function AddItemForViet200906()
	if EventOpen0906() == 0 then
		return
	end
	if tonumber(date("%y%m%d%H")) >= 09071924 or tonumber(date("%y%m%d%H")) < 09061900 then
		return
	end

		--Ìí¼Ó¸¨Öú
	if GetTask(TASK_GET_FUZHU_DATE) >= tonumber(date("%y%m%d")) then
		if GetTask(TASK_GET_FUZHU_TYPE) ~= 0 then
			local nType = floor(GetTask(TASK_GET_FUZHU_TYPE) / 10);
			local nRandAttr = mod(GetTask(TASK_GET_FUZHU_TYPE), 10);
			local nHour = tonumber(date("%H"));
			local nMin = tonumber(date("%M"));
			local nSec = tonumber(date("%S"));
			local nLeftTime = ((23 - nHour) * 60 * 60 + (59 - nMin) * 60 + (60 - nSec)) * 18;
			if nType == 1 then
				for i = 1, getn(tb_InBuff[nRandAttr][3]) do
					CastState(tb_InBuff[nRandAttr][3][i][1], tb_InBuff[nRandAttr][3][i][2], nLeftTime);
				end
			else
				for i = 1, getn(tb_OutBuff[nRandAttr][3]) do
					CastState(tb_OutBuff[nRandAttr][3][i][1], tb_OutBuff[nRandAttr][3][i][2], nLeftTime);
				end
			end
		end
	end

	--´´½¨´¥·¢Æ÷£­É±ÅÖÍÃ×ÓµôÏä×Ó
	local tID = 1243;
	local cID = 2507;
	local nCreateFlag = 0;
	if GetTrigger(cID) == 0 then
		if CreateTrigger(0, tID, cID) == 0 then	--´´½¨É±¹Ö´¥·¢Æ÷
			nCreateFlag = 1													--´¥·¢Æ÷´´½¨Ê§°ÜÁË
		end
	end
	if nCreateFlag == 1 then
		WriteLog("Hoat dong truy tim tho map:"..GetName().."Tao quai loi (2507)")
	end

	if GetItemCount(2, 1, 30045) ~= 0 then
		return
	end
	local nRetCode, nItem = 0;
	nRetCode = AddItem(2, 1, 30045, 1);
	if nRetCode == 1 then
		gf_SetItemExpireTime(nItem, 2009, 7, 20, 0, 0, 0);
		Msg2Player("§¹i hiÖp ®· nhËn 1 cÈm nang ®¹i sù kiÖn");
	end
end

function first_tong_pk_config()
	if is_first_tong_jpz_open() == 0 then
		return
	end
	if GetTrigger(2502) == 0 then
		if CreateTrigger(2,3001,2502) == 0 then
			WriteLog(g_LogTitle.."[Account: "..GetAccount().."][Role Name:"..GetName().."] CreateTrigger(2,3001,2502) Failed. ")
		end
	end;
	if GetTrigger(2503) == 0 then
		if CreateTrigger(2,3002,2503) == 0 then
			WriteLog(g_LogTitle.."[Account: "..GetAccount().."][Role Name:"..GetName().."] CreateTrigger(2,3002,2503) Failed. ")
		end
	end;
	local nHour = tonumber(date("%H"));
	local nMapID = GetWorldPos();
	if nMapID ~= 106 then
		return
	end
	if nHour == 17 or nHour == 18 then	--  17£º00-18£º00 ÁúÈª´åµØÍ¼ÎŞpk³Í·£
		SetDeathPunish(0);
	end
end

function AddItemForViet200909()
	if tonumber(date("%y%m%d%H")) >= 09102524 or tonumber(date("%y%m%d%H")) < 09091800 then
		return
	end

	--Ìí¼Ó¸¨Öú
--	if GetTask(VIET_0909_TASK_GET_FUZHU_DATE) >= tonumber(date("%y%m%d")) then
--		if GetTask(VIET_0909_TASK_GET_FUZHU_TYPE) ~= 0 then
--			local nType = floor(GetTask(VIET_0909_TASK_GET_FUZHU_TYPE) / 10);
--			local nRandAttr = mod(GetTask(VIET_0909_TASK_GET_FUZHU_TYPE), 10);
--			local nHour = tonumber(date("%H"));
--			local nMin = tonumber(date("%M"));
--			local nSec = tonumber(date("%S"));
--			local nLeftTime = ((23 - nHour) * 60 * 60 + (59 - nMin) * 60 + (60 - nSec)) * 18;
--			if nType == 1 then
--				for i = 1, getn(viet_0909_tb_InBuff[nRandAttr][3]) do
--					CastState(viet_0909_tb_InBuff[nRandAttr][3][i][1], viet_0909_tb_InBuff[nRandAttr][3][i][2], nLeftTime);
--				end
--			else
--				for i = 1, getn(viet_0909_tb_OutBuff[nRandAttr][3]) do
--					CastState(viet_0909_tb_OutBuff[nRandAttr][3][i][1], viet_0909_tb_OutBuff[nRandAttr][3][i][2], nLeftTime);
--				end
--			end
--		end
--	end
	
	--¸ø½õÄÒ´óÊÂ¼ş
	if GetItemCount(2, 1, 30045) ~= 0 then
		return
	end
	local nRetCode, nItem = AddItem(2, 1, 30045, 1);
	if nRetCode == 1 then
		gf_SetItemExpireTime(nItem, 2009, 10, 26, 0, 0, 0);
		Msg2Player("§¹i hiÖp ®· nhËn 1 cÈm nang ®¹i sù kiÖn");
	end
end

function AddItemForViet200911()
	if BigGetItemCount(2, 1, 30045) == 0 then		
		AddItem(2, 1, 30045, 1);
		Msg2Player("§¹i hiÖp ®· nhËn 1 cÈm nang ®¹i sù kiÖn");		
	end
	if BigGetItemCount(2, 0, 1043) == 0 then		
		AddItem(2, 0, 1043, 1);
		Msg2Player("§¹i hiÖp ®· nhËn 1 NguyÖt L­îng Thè luyÖn ®¬n l­");		
	end
end

function AddItemForViet200912()
	if tonumber(date("%y%m%d")) >= 100117 or tonumber(date("%y%m%d")) < 091218 then
		return
	end
	--¸ø½õÄÒ´óÊÂ¼ş
	if GetItemCount(2, 1, 30045) ~= 0 then
		return
	end
	local nRetCode, nItem = AddItem(2, 1, 30045, 1);
	if nRetCode == 1 then
		gf_SetItemExpireTime(nItem, 2010, 1, 17, 0, 0, 0);
		Msg2Player("§¹i hiÖp ®· nhËn 1 cÈm nang ®¹i sù kiÖn");
	end
end

function ProtectRes()
	TSK_PK_FLAG = 1539
	local nDate = tonumber(date("%w%H"))
	if nDate >= 319 and nDate < 320 then
		local nMapID, nX, nY = GetWorldPos()
		if nMapID == 304 then			
			local szTongName, nCessBuysell, nCessStore, nTime = GetCityWarInfo(300, "base")	
			if IsTongMember() == 0 or GetTongName() ~= szTongName then
				LeaveTeam()
				local nFlag = random(2,3)
				SetPKFlag(1,nFlag)
				ForbidChangePK(1)
				SetTask(TSK_PK_FLAG,1)
			end		
		else
			if GetTask(TSK_PK_FLAG) == 1 then
				ForbidChangePK(0)
				SetTask(TSK_PK_FLAG,0)
			end
		end
	else
		if GetTask(TSK_PK_FLAG) == 1 then
			ForbidChangePK(0)
			SetTask(TSK_PK_FLAG,0)
		end	
	end
end

--È¡³öÈÕ³£»î¶¯µÄÀàĞÍ
function set_ruchangrenwu_type()
    if DAILY_TASK_0912_SWITCH ~= 1 then
        return 0;
    end
    if GetGlbValue(DAILY_TASK_0912_PERSONAL_TASK) == 0  or GetGlbValue(DAILY_TASK_0912_TEAM_TASK) == 0 then
        ApplyRelayShareData("richangrenwu_type", 0, 0, "\\script\\global\\playerloginin.lua", "get_type_callback");
    end
end

function get_type_callback(szKey, nKey1, nKey2, nCount)
		if szKey == "" then
			szKey, nKey1, nKey2 = _szkey, _nkey1, _nkey2
		end
		if nCount == 0 then
			-- Ã»ÓĞ¼ÇÂ¼
			return 0;
		end
    local nPersonalTask, nTeamTask = GetRelayShareDataByKey(szKey, nKey1, nKey2, "type");
    DelRelayShareDataCopy(szKey,nKey1,nKey2);
    if nPersonalTask and nTeamTask then
        SetGlbValue(DAILY_TASK_0912_PERSONAL_TASK, nPersonalTask);
        SetGlbValue(DAILY_TASK_0912_TEAM_TASK, nTeamTask);
        return 0;
    end
    if not nPersonalTask then
        SetGlbValue(DAILY_TASK_0912_PERSONAL_TASK, 1);
    end
    if not nTeamTask then
        SetGlbValue(DAILY_TASK_0912_TEAM_TASK, 1);
    end
end

function init_new_server()
	if GetTask(TSK_CHANGE_SERVER) ~= GetGlbValue(GLB_TSK_SERVER_ID) and GetTask(TSK_CHANGE_SERVER) ~= 0 then
		 if GetTask(701) > 80000 then
		 	SetTask(701, 80000)
		 elseif GetTask(701) < -80000 then
		 	SetTask(701, -80000)
		 end
		 CalcBattleRank()
		 UpdateBattleMaxRank()
		 SetTask(TSK_SETQC_NEWSERVER, 1)
		 Talk(1, "", "Qu©n c«ng cña b¹n ®· ®­îc ®iÒu chØnh vÒ møc 80000!")
		  gf_WriteLogEx("RESET DIEM QUAN CONG 80K", "reset thµnh c«ng", 1, "Reset Qu©n C«ng")
	end
--	if gf_GetTaskByte(TSK_SERVER_ID, TSK_SERVER_ID_CUR) == 62 and GetGlbValue(GLB_TSK_SERVER_ID) ~= 62 and tonumber(date("%Y%m%d")) <= 20101203 or 
--	gf_GetTaskByte(TSK_SERVER_ID, TSK_SERVER_ID_CUR) ~= 63 and GetGlbValue(GLB_TSK_SERVER_ID) == 63 and tonumber(date("%Y%m%d")) <= 20110220 then
--		gf_SetTaskByte(TSK_SERVER_ID, TSK_SERVER_ID_CUR, GetGlbValue(GLB_TSK_SERVER_ID))
--		local szNation = get_nationality_name(GetGlbValue(GLB_TSK_SERVER_ID))
--		Talk(1, "", "B¹n ®· trë thµnh ng­êi cña "..szNation.." quèc!")
--	end
end

function Init_Change_Server()
	SetTask(TSK_CHANGE_SERVER,GetGlbValue(GLB_TSK_SERVER_ID))
end

function vng_set_nationality()
	if GetTask(TSK_SERVER_ID) == 0 or gf_GetTaskByte(TSK_SERVER_ID, TSK_SERVER_ID_CUR) == 0 then
		gf_SetTaskByte(TSK_SERVER_ID, TSK_SERVER_ID_CUR, GetGlbValue(GLB_TSK_SERVER_ID))
		return
	end
	if gf_GetTaskByte(TSK_SERVER_ID, TSK_SERVER_ID_NEW) ~= GetGlbValue(GLB_TSK_SERVER_ID) then
		gf_SetTaskByte(TSK_SERVER_ID, TSK_SERVER_ID_NEW, 0)
		SetTask(TSK_SERVER_ID_TIME,0)
		return
	end
end

-- Danh s¸ch hç trî BKL 24/05/2012
tbListDenBu120406 =
{
		[1] = {38, 'tantriquaidao77', '1stAnhTuan'},
}

function DenBu_BKL()
	for i = 1, getn(tbListDenBu120406) do
		if GetTask(TSK_BKL_BONUS) == 0 and GetGlbValue(1023) == tbListDenBu120406[i][1] and GetAccount() == tbListDenBu120406[i][2] and GetName() == tbListDenBu120406[i][3] then
			SetTask(TSK_BKL_BONUS, 1)
			SetTask(701,GetTask(701) + 800000)
			Talk(1,"","B¹n ®· ®­îc nhËn l¹i 800.000 ®iÓm c«ng tr¹ng phe Tèng!")
			WriteLogEx("DEN BU CONG TRANG THANG 8","nhËn",800000,"c«ng tr¹ng")
		end
	end
end

--==========================================201110ÔÂº£ÉÏÁúÖÛÕ½==============================
function dragon_boat_201110()
	--print("PlayerLoginIn called &&&&&&&&&&")
	SetTask(1715,0)
	SetTask(VET_LZZ_PLAYER_1715,0)
	-------------------
	SetLogoutRV(0) 	--ÉèÖÃµÇÂ½µãÎª³ÇÊĞÖØÉúµã
	SetDeathPunish(1) 	--ÎŞËÀÍö³Í·£
	SetCreateTeam(0) 	--¹Ø±Õ×é½¨¶ÓÎé(ÏÂÏßºó»á±»Çåµô)
	ForbitTrade(0) 	--½ûÖ¹½»Ò×
	InteractiveEnable(1) 	--¹Ø±Õ½»»¥	±ØĞëÔÚNewWorldÖ®ºóÖ´ĞĞ²ÅÓĞĞ§
	StallEnable(1) 	--½ûÖ¹°ÚÌ¯(ÏÂÏßºó»á±»Çåµô)
	UseScrollEnable(1) 	--½ûÖ¹Ê¹ÓÃ»Ø³Ç·û
	ForbidChangePK(0) 	--ÔÊĞí¸Ä±äPK×´Ì¬
	SetPKFlag(0,0)
	--ForbidChangePK(1) 	--½ûÖ¹¸Ä±äPK×´Ì¬
	SetFightState(0)
	----------------------------------------
	SetDeathScript("")
	SetTempRevPos(0,0,0)
	SetCampToPlayer("")
	RemvoeTempEffect()  --Çå³ıÍæ¼ÒÉíÉÏµÄËùÓĞÁÙÊ±×´Ì¬
	--½â³ı×ù¼ÄÉÏµÄ×°±¸
	UnEquipAtPosition(10)
	--É¾³ıÁúÖÛ
	local nResult = 0
	if BigDelItem(0,105,30034,1) ~= 1 then
		nResult = nResult + 1
	end
	if BigDelItem(0,105,30035,1) ~= 1 then
		nResult = nResult + 1
	end
	if BigDelItem(0,105,30036,1) ~= 1 then
		nResult = nResult + 1
	end
	if BigDelItem(0,105,30037,1) ~= 1 then
		nResult = nResult + 1
	end
	if nResult == 4 then
		WriteLog("[H¶i ChiÕn Long Ch©u]: Xãa thuyÒn rång thÊt b¹i")
	end
	--ÖØÖÃÈÎÎñ±äÁ¿
	if nResult ~= 4 then
		SetTask(2927,0)
	end
end

function removeLiangshan()
	local tLSBuffInfo = {9922,9923,9924,9925,9926,9927,9908,9909,9910,9911}
	for i =1, getn(tLSBuffInfo) do
		RemoveState(tLSBuffInfo[i])
	end
	--ÁúÖÛ¼¼ÄÜ
	local skill_id
	for skill_id = 30104,30120 do
		RemoveSkill(skill_id)
	end
	--ÆøĞıÉñ¹¦  ¡ª¡ªÁºÉ½
	RemoveSkill(1424)
	--Ñ©ÕÌ
	for skill_id = 30001,30009 do
		RemoveSkill(skill_id)
	end
end

function treasure_box()
	if gf_CheckEventDateEx(46) == 1 then
		if CreateTrigger(3,3005,3005*2) == 0 then
			return 0
		end
		if CreateTrigger(1,1516,1516*2) == 0 then
			return 0
		end
		ContinueTimer(GetTrigger(1516*2))
	end
end

--gtaskÖ§³ÖNPC¶Ô»°´¥·¢Æ÷ [·¢ÏÖ´¥·¢Æ÷ÓĞÒì³£]
function gtask_support()
	if IsNewTaskSystemOpen() ~= 1 then
		return 0;
	end
	if GetTrigger(4000) ~= 0 then
		RemoveTrigger(GetTrigger(4000));
	end;
	CreateTrigger(4, 3110, 4000);
end

function get_message_task()
	--¹¦ÄÜÊÇ·ñ´ò¿ª
	if IsMissionTaskSystemOpen() ~= 1 then
		return 0;
	end
	--¸øĞÅ¼ş74ºÅÈÎÎñ
	--print("new_task_npc_create2 =",tGtTask:check_task_isfinish(74))
	if tGtTask:check_task_isfinish(74) == 0 then
		local nLevel = GetLevel();
		if nLevel < 80 or GetPlayerFaction() == 0 then
			--Msg2Player("Íæ¼Ò80¼¶ÒÔÉÏ¡¢ÒÑ¼ÓÈëÁ÷ÅÉ²Å¿ÉÒÔ»ñµÃÉñÃØĞÅ¼ş¡£")
			return 0;
		end
		if GetItemCount(2,0,30052) == 0 then
			if gf_Judge_Room_Weight(1,1) ~= 1 then
			--Msg2Player("±³°ü¿Õ¼ä²»×ã£¬ÎŞ·¨»ñµÃÉñÃØĞÅ¼ş¡£")
		    return 0
			end
			AddItem(2,0,30052,1);
			Msg2Player("C¸c h¹ nhËn ®­îc th­ bİ Èn");
		end
	else
		if GetItemCount(2,0,30052) ~= 0 then
			DelItem(2,0,30052,GetItemCount(2,0,30052))
		end
	end
end

--¸øÓè°ËØÔ±¦µä
--function give_baguabaodian()
--	local nLevel = GetLevel();
--	if nLevel >= 80 then
--		if GetItemCount(2,1,2639) <= 0 then
--			AddItem(2,1,2639,1);
--		end
--	end
--end


--´´½¨ÁºÉ½µôÂä´¥·¢Æ÷
function LSB_Challenge_Trigger()
	if LSB_IsActivityOpen() == 1 then
		if GetTrigger(1275*2) == 0 then
			CreateTrigger(0,1275,1275*2);
		end
	else
		if GetTrigger(1275*2) ~= 0 then
			RemoveTrigger(GetTrigger(1275*2));
		end
		--É¾³ı¹ıÆÚÈÎÎñ
		DirectDeleteTask(89);
		DirectDeleteTask(90);
		DirectDeleteTask(91);
	end
end

--°ÂÔË»î¶¯µôÂä´¥·¢Æ÷
function oly_create_trigger()
	if oly_IsActivityOpen() == 1 then
		local nLevel = GetLevel();
		if nLevel < 70 or gf_Check55FullSkill() == 0 or GetPlayerFaction() == 0 then
			return 0;
		end
		if GetTrigger(1276*2) == 0 then
			CreateTrigger(0,1276,1276*2);
		end
	else
		if GetTrigger(1276*2) ~= 0 then
			RemoveTrigger(GetTrigger(1276*2));
		end
	end
end

--×·»Ø×ÖÌû´ó×÷Õ½
function dzt_tmz_trigger()
	if dzt_activity_isopen() == 1 then
		if dzt_check_condition(1) ~= 1 then
			return 0;
		end
		if GetTrigger(1278*2) == 0 then
			CreateTrigger(0,1278,1278*2);
		end
	else
		if GetTrigger(1278*2) ~= 0 then
			RemoveTrigger(GetTrigger(1278*2));
		end
	end
end
